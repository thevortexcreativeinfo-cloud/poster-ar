<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR · Start fijo</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* Cámara detrás del canvas */
  video[playsinline]{
    position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important
  }
  /* Canvas/WebGL arriba pero sin capturar eventos */
  a-scene{position:fixed!important;inset:0!important;z-index:2!important;pointer-events:none!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:none!important}

  /* UI por encima y clicable siempre */
  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9999;pointer-events:auto}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.3 system-ui;z-index:9999;pointer-events:auto}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button">📷 Abrir cámara</button>
  <button id="btnSound" class="btn" type="button" hidden>🔊 Activar sonido</button>
</div>
<div id="dbg" class="dbg">Cargando…</div>

<a-scene id="scene"
  embedded vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:true"
  renderer="alpha:true;antialias:true;logarithmicDepthBuffer:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;"
  style="width:100vw;height:100vh">

  <a-assets id="assets" timeout="60000">
    <img id="overlayImg" crossorigin="anonymous"
         src="https://res.cloudinary.com/dtge9nklw/image/upload/v1759311815/poster_sin_foto_cancion_ztjqvw.png"/>
    <video id="v1" playsinline webkit-playsinline muted autoplay loop preload="auto" crossorigin="anonymous"
           src="https://res.cloudinary.com/dtge9nklw/video/upload/f_mp4,vc_h264,ac_aac,br_1200k,vs_30,w_1280/v1759311664/0_Couple_Beach_3840x2160_fgnn6o.mp4"></video>
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(function(){
  const STATE=document.getElementById('dbg');
  const say = (m)=>{ STATE.textContent=m; console.log('[AR]',m); };

  const scene = document.getElementById('scene');
  const anchor= document.getElementById('anchor');
  const btnStart = document.getElementById('btnStart');
  const btnSound = document.getElementById('btnSound');

  // --- TU TARGET (.mind)
  const TARGET_URL = 'https://res.cloudinary.com/dtge9nklw/raw/upload/v1759341741/targets_10_h3yoq9.mind';
  scene.setAttribute('mindar-image', `imageTargetSrc: ${TARGET_URL}; uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;`);

  // Cámara en cover garantizada si MindAR reinyecta el <video>
  new MutationObserver(()=>{ document.querySelectorAll('video').forEach(v=>{
    if(v.srcObject instanceof MediaStream){
      Object.assign(v.style,{objectFit:'cover',position:'fixed',inset:'0',width:'100vw',height:'100vh',zIndex:'0',background:'#000'});
    }
  });}).observe(document.documentElement,{subtree:true,childList:true});

  // Overlay y vídeo (rectángulo medido en px del diseño base 2481x3508)
  const PW=2481, PH=3508, H=PH/PW;
  const px2=(x,y,w,h)=>({wn:w/PW,hn:h/PW,cx:-0.5+(x+w/2)/PW,cy:H/2-(y+h/2)/PW});

  const root=document.createElement('a-entity'); anchor.appendChild(root);

  // Overlay completo
  const overlay=document.createElement('a-plane');
  overlay.setAttribute('width',1); overlay.setAttribute('height',H);
  overlay.setAttribute('position','0 0 0.0');
  overlay.setAttribute('material','shader:flat; src:#overlayImg; transparent:true; side:double; depthTest:false; opacity:1');
  root.appendChild(overlay);

  // Vídeo
  const vSlot = {x:296, y:316, w:1890, h:1682}; // ajusta si hace falta
  const u=px2(vSlot.x,vSlot.y,vSlot.w,vSlot.h);
  const vPlane=document.createElement('a-plane');
  vPlane.setAttribute('width',u.wn); vPlane.setAttribute('height',u.hn);
  vPlane.setAttribute('position',`${u.cx} ${u.cy} 0.03`);
  vPlane.setAttribute('material','shader:flat; src:#v1; side:double; depthTest:false; opacity:1');
  root.appendChild(vPlane);

  // COVER de la textura del vídeo
  const vid=document.getElementById('v1');
  function cover(){
    const mesh=vPlane.getObject3D('mesh'); if(!mesh||!mesh.material||!mesh.material.map||!vid.videoWidth) return;
    const tex=mesh.material.map, vr=vid.videoWidth/vid.videoHeight, rr=vSlot.w/vSlot.h; let rx=1,ry=1,ox=0,oy=0;
    if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
    tex.offset.set(ox,oy); tex.repeat.set(rx,ry); tex.needsUpdate=true; mesh.material.needsUpdate=true;
  }
  vPlane.addEventListener('materialtextureloaded',cover);
  vid.addEventListener('loadedmetadata',()=>{ vid.play().catch(()=>{}); cover(); }, {once:true});

  // ======= Inicio de cámara robusto =======
  async function startAR(){
    try{
      const sys  = scene.systems && scene.systems['mindar-image-system'];
      const comp = scene.components && scene.components['mindar-image'];
      if(sys && sys.start)         await sys.start();
      else if(comp && comp.start)  await comp.start();
      else if (scene.el && scene.el.systems && scene.el.systems['mindar-image-system'])
        await scene.el.systems['mindar-image-system'].start();

      btnStart.disabled = true;
      btnStart.textContent = 'Cámara lista';
      say('Cámara iniciada');
    }catch(e){
      console.warn(e);
      say('⚠️ No se pudo iniciar cámara (permisos/navegador)');
    }
  }

  // Botón: click + touchstart (por si el navegador no emite click)
  ['click','touchstart'].forEach(evt=>{
    btnStart.addEventListener(evt, (ev)=>{ ev.preventDefault(); ev.stopPropagation(); startAR(); }, {passive:false});
  });

  // Auto-arranque cuando la escena está lista + primer toque en la pantalla
  scene.addEventListener('loaded', ()=>{ try{ scene.renderer.setClearColor(0x000000,0); }catch{}; say('Scene lista'); startAR(); });
  window.addEventListener('pointerup', ()=>startAR(), {once:true, passive:true});

  // Logs de tracking
  anchor.addEventListener('targetFound', ()=>{ vid.play().catch(()=>{}); say('Target FOUND'); });
  anchor.addEventListener('targetLost',  ()=>{ vid.pause(); say('Target LOST…'); });

  scene.addEventListener('arReady', ()=>say('Cámara OK'));
  scene.addEventListener('arError',  e=>say('Error cámara/permisos'));
})();
</script>
</body>
</html>
