<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR ¬∑ Universal</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* C√°mara detr√°s */
  video[playsinline]{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important}
  /* WebGL delante */
  a-scene{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:auto!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:4!important;pointer-events:auto!important}
  /* UI */
  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.3 system-ui;z-index:8;pointer-events:none;opacity:.16;transition:opacity .35s}
  .dbg:hover{opacity:1}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button">üì∑ Abrir c√°mara</button>
  <button id="btnAudio" class="btn" type="button" disabled>‚ñ∂Ô∏è Audio</button>
</div>
<div id="dbg" class="dbg">Listo‚Ä¶</div>

<a-scene id="scene"
  embedded vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:true"
  renderer="alpha:true;antialias:true;logarithmicDepthBuffer:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;"
  style="width:100vw;height:100vh">

  <a-assets timeout="60000">
    <!-- SRC por defecto para evitar warning de a-assets; el JSON puede sobrescribirlo -->
    <video id="v1"
      src="https://res.cloudinary.com/dtge9nklw/video/upload/v1759311664/0_Couple_Beach_3840x2160_fgnn6o.mp4"
      playsinline webkit-playsinline muted autoplay loop preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <a-camera id="cam" look-controls="enabled:false">
    <a-entity id="mouseRay" cursor="rayOrigin: mouse"
              raycaster="objects: .ui3d,.heart,.dragplane; far: 3"></a-entity>
  </a-camera>

  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(function(){
  var qs = new URLSearchParams(location.search);
  function log(m){
    var el=document.getElementById('dbg');
    el.textContent = m+' ¬∑ '+new Date().toLocaleTimeString();
    el.style.opacity=.9; setTimeout(function(){el.style.opacity=.16;},1200);
    console.log('[AR]',m);
  }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

  function setRO(el, order, depthTest, depthWrite){
    el.addEventListener('loaded', function(){
      var mesh = el.getObject3D('mesh'); if(!mesh) return;
      mesh.renderOrder = order;
      if(mesh.material){
        mesh.material.depthTest=!!depthTest;
        mesh.material.depthWrite=!!depthWrite;
        mesh.material.needsUpdate=true;
      }
    });
  }

  /* ---------- Cargar JSON ---------- */
  var cfgUrl = qs.get('cfg');
  if(!cfgUrl){ log('Falta ?cfg=URL_DEL_JSON'); return; }

  fetch(cfgUrl,{mode:'cors',cache:'no-store'}).then(function(r){
    return r.json();
  }).then(function(CFG){

    /* ---------- MindAR ---------- */
    var scene = document.getElementById('scene');
    scene.setAttribute('mindar-image',
      'imageTargetSrc:'+CFG.target+'; uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;');

    // poner la c√°mara del dispositivo en cover
    new MutationObserver(function(){
      Array.prototype.forEach.call(document.querySelectorAll('video'), function(v){
        if(v.srcObject instanceof MediaStream){
          Object.assign(v.style,{objectFit:'cover',position:'fixed',inset:'0',width:'100vw',height:'100vh',zIndex:'0',background:'#000'});
        }
      });
    }).observe(document.documentElement,{subtree:true,childList:true});

    var PW=CFG.pw||2481, PH=CFG.ph||3508, H=PH/PW;
    function px2(x,y,w,h){
      return { wn:w/PW, hn:h/PW, cx:-0.5+(x+w/2)/PW, cy:H/2-(y+h/2)/PW };
    }

    var anchor=document.getElementById('anchor');
    var root=document.createElement('a-entity'); anchor.appendChild(root);
    var cal=Object.assign({dx:0,dy:0,scale:1,rot:0}, CFG.cal||{});
    root.setAttribute('position', (cal.dx/PW)+' '+(-cal.dy/PW)+' 0');
    root.setAttribute('scale', cal.scale+' '+cal.scale+' 1');
    root.setAttribute('rotation', '0 0 '+cal.rot);

    /* ---------- Fondo ---------- */
    var paper=document.createElement('a-plane');
    paper.setAttribute('width',1); paper.setAttribute('height',H);
    paper.setAttribute('position','0 0 -0.02');
    paper.setAttribute('material','shader:flat; color:#ffffff; side:double; transparent:false');
    root.appendChild(paper); setRO(paper, 1, false, false);

    /* ---------- Marco animado ---------- */
    var vslot=CFG.slotVid, u=px2(vslot.x,vslot.y,vslot.w,vslot.h);
    var glow1 = (CFG.colors && CFG.colors.wave1) ? CFG.colors.wave1 : '#13d77a';
    var glow2 = (CFG.colors && CFG.colors.wave2) ? CFG.colors.wave2 : '#ffd54a';

    var frame=document.createElement('a-plane');
    frame.setAttribute('width',u.wn*1.012); frame.setAttribute('height',u.hn*1.012);
    frame.setAttribute('position',u.cx+' '+u.cy+' 0.000');
    frame.setAttribute('material','shader:flat; color:#e9eef2; side:double; transparent:false');
    root.appendChild(frame); setRO(frame, 5, false, false);

    (function stripsGlow(){
      var t=0.004, z=0.018;
      var strips=[
        {w:u.wn*1.01,h:t,   x:u.cx,           y:u.cy+u.hn/2+t/2},
        {w:u.wn*1.01,h:t,   x:u.cx,           y:u.cy-u.hn/2-t/2},
        {w:t,       h:u.hn, x:u.cx-u.wn/2-t/2,y:u.cy},
        {w:t,       h:u.hn, x:u.cx+u.wn/2+t/2,y:u.cy},
      ];
      strips.forEach(function(s,i){
        var p=document.createElement('a-plane');
        p.setAttribute('width',s.w); p.setAttribute('height',s.h);
        p.setAttribute('position',s.x+' '+s.y+' '+z);
        var col = (i%2)? glow2 : glow1;
        p.setAttribute('material','shader:standard; color:'+col+'; emissive:'+col+'; emissiveIntensity:0.24; roughness:1; metalness:0; transparent:true; opacity:.95');
        p.setAttribute('animation__glow','property:material.emissiveIntensity; from:0.18; to:0.42; dir:alternate; dur:1200; loop:true; easing:easeInOutSine');
        root.appendChild(p); setRO(p, 20, false, false);
      });
    })();

    (function runners(){
      var z=0.019, w=0.02, h=0.006, dur=1800;
      function runner(x1,y1,x2,y2,color){
        var r=document.createElement('a-plane');
        r.setAttribute('width',w); r.setAttribute('height',h);
        r.setAttribute('position',x1+' '+y1+' '+z);
        r.setAttribute('material','shader:standard; color:'+color+'; emissive:'+color+'; emissiveIntensity:0.9; roughness:1; metalness:0; transparent:true; opacity:1');
        r.setAttribute('animation__go','property:position; to:'+x2+' '+y2+' '+z+'; dur:'+dur+'; dir:alternate; loop:true; easing:easeInOutSine');
        root.appendChild(r); setRO(r, 25, false, false);
      }
      runner(u.cx-u.wn/2, u.cy+u.hn/2+0.01, u.cx+u.wn/2, u.cy+u.hn/2+0.01, glow1);
      runner(u.cx+u.wn/2, u.cy-u.hn/2-0.01, u.cx-u.wn/2, u.cy-u.hn/2-0.01, glow2);
      runner(u.cx-u.wn/2-0.01, u.cy-u.hn/2, u.cx-u.wn/2-0.01, u.cy+u.hn/2, glow2);
      runner(u.cx+u.wn/2+0.01, u.cy+u.hn/2, u.cx+u.wn/2+0.01, u.cy-u.hn/2, glow1);
    })();

    /* ---------- V√≠deo ---------- */
    var v1=document.getElementById('v1');
    v1.crossOrigin='anonymous'; v1.muted=true; v1.playsInline=true;
    v1.setAttribute('playsinline','true'); v1.setAttribute('webkit-playsinline','true');
    if (CFG.video && CFG.video !== v1.currentSrc) { v1.src = CFG.video; v1.load(); }

    var vPlane=document.createElement('a-plane');
    vPlane.setAttribute('width',u.wn);
    vPlane.setAttribute('height',u.hn);
    vPlane.setAttribute('position',u.cx+' '+u.cy+' 0.02');
    vPlane.setAttribute('material','shader:flat; side:double; transparent:false; src:#v1');
    root.appendChild(vPlane); setRO(vPlane, 100, true, true);

    function coverFromMap(map){
      if(!map || !v1.videoWidth) return;
      var vr=v1.videoWidth/v1.videoHeight, rr=vslot.w/vslot.h;
      var rx=1,ry=1,ox=0,oy=0;
      if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
      map.offset.set(ox,oy); map.repeat.set(rx,ry); map.needsUpdate=true;
    }
    vPlane.addEventListener('materialtextureloaded', function(e){ coverFromMap(e.detail.texture); });
    v1.addEventListener('loadedmetadata', function(){
      var m=vPlane.getObject3D('mesh'); if(m && m.material && m.material.map) coverFromMap(m.material.map);
    });

    function forceThreeVideoTexture(){
      var mesh=vPlane.getObject3D('mesh'); if(!mesh) return;
      if(!mesh.material.map && v1.readyState>=2){
        var tex=new AFRAME.THREE.VideoTexture(v1);
        tex.needsUpdate=true;
        mesh.material.map=tex; mesh.material.needsUpdate=true;
        coverFromMap(tex);
        log('Fallback a THREE.VideoTexture');
      }
    }
    function checkBlackFallback(){
      var m=vPlane.getObject3D('mesh');
      var map=m && m.material ? m.material.map : null;
      if(!v1.videoWidth || !map) forceThreeVideoTexture();
    }

    /* ---------- Canvas overlay: textos + barra musical ---------- */
    var Cw=2048, Ch=Math.round(Cw*H);
    var canvas=document.createElement('canvas'); canvas.width=Cw; canvas.height=Ch;
    var ctx=canvas.getContext('2d');

    var overlay=document.createElement('a-plane');
    overlay.setAttribute('width',1); overlay.setAttribute('height',H);
    overlay.setAttribute('position','0 0 0.0');
    overlay.setAttribute('material','shader:flat; transparent:true; side:double; opacity:1');
    root.appendChild(overlay); setRO(overlay, 3, false, false);
    overlay.addEventListener('loaded', function(){
      var tex=new AFRAME.THREE.CanvasTexture(canvas); tex.needsUpdate=true;
      var m=overlay.getObject3D('mesh'); m.material.map=tex; m.material.needsUpdate=true; overlay.__tex=tex;
    });

    var titleSlot=CFG.slotTitle, artistSlot=CFG.slotArtist, barSlot=CFG.slotBar;
    function fitFontFor(text,wpx,hpx,weight){
      var lo=12, hi=Math.floor(hpx*0.92), best=Math.floor(hpx*0.74);
      while(lo<=hi){
        var mid=(lo+hi>>1);
        ctx.font=(weight||700)+' '+mid+'px system-ui,Segoe UI,Roboto';
        if(ctx.measureText(text).width<=wpx*0.94){ best=mid; lo=mid+1; } else { hi=mid-1; }
      }
      return best;
    }
    var titlePx=fitFontFor(CFG.title||'', titleSlot.w*Cw/PW, titleSlot.h*Ch/PH, 800);
    var artistPx=fitFontFor(CFG.artist||'',artistSlot.w*Cw/PW, artistSlot.h*Ch/PH, 600);

    var btnAudio=document.getElementById('btnAudio');
    var audio=null, acx=null, analyser=null;
    function setupAudio(){
      if(audio) return;
      audio=new Audio(CFG.audio||''); audio.crossOrigin='anonymous'; audio.preload='auto';
      try{
        var AC=window.AudioContext||window.webkitAudioContext;
        acx=new AC();
        analyser=acx.createAnalyser();
        analyser.fftSize=128;
        analyser.smoothingTimeConstant=0.88;
        var src=acx.createMediaElementSource(audio);
        src.connect(analyser); analyser.connect(acx.destination);
      }catch(e){}
      audio.addEventListener('play', function(){ btnAudio.textContent='‚è∏ Audio'; });
      audio.addEventListener('pause',function(){ btnAudio.textContent='‚ñ∂Ô∏è Audio'; });
    }
    btnAudio.onclick=function(){
      setupAudio();
      try{
        if(audio.paused){
          if(acx && acx.state==='suspended'){ acx.resume().then(function(){ audio.play(); }); }
          else{ audio.play(); }
        }else{
          audio.pause();
        }
      }catch(e){}
    };

    var BARS=48, waveH=Math.round(36*Cw/2048), gap=Math.round(24*Cw/2048);
    var levels=new Array(BARS).fill(0), peaks=new Array(BARS).fill(0);
    function mmss(t){ if(!isFinite(t)||t<0) t=0; var m=Math.floor(t/60), s=Math.floor(t%60); return m+':'+String(s).padStart(2,'0'); }

    function draw(){
      ctx.clearRect(0,0,Cw,Ch);

      // T√≠tulo
      var tx=Math.round(titleSlot.x*Cw/PW), ty=Math.round(titleSlot.y*Ch/PH),
          tw=Math.round(titleSlot.w*Cw/PW), th=Math.round(titleSlot.h*Ch/PH);
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font='800 '+titlePx+'px system-ui,Segoe UI,Roboto';
      ctx.fillStyle='rgba(0,0,0,.28)'; ctx.fillText(CFG.title||'', tx+tw/2+2, ty+th/2+2);
      ctx.fillStyle=(CFG.colors && CFG.colors.title)||'#000'; ctx.fillText(CFG.title||'', tx+tw/2, ty+th/2);

      // Artista
      var ax=Math.round(artistSlot.x*Cw/PW), ay=Math.round(artistSlot.y*Ch/PH),
          aw=Math.round(artistSlot.w*Cw/PW), ah=Math.round(artistSlot.h*Ch/PH);
      ctx.font='600 '+artistPx+'px system-ui,Segoe UI,Roboto';
      ctx.fillStyle='rgba(0,0,0,.18)'; ctx.fillText(CFG.artist||'', ax+aw/2+1.8, ay+ah/2+1.8);
      ctx.fillStyle=(CFG.colors && CFG.colors.artist)||'#000'; ctx.fillText(CFG.artist||'', ax+aw/2, ay+ah/2);

      // Barra base
      var pbx=Math.round(barSlot.x*Cw/PW), pby=Math.round(barSlot.y*Ch/PH),
          pbw=Math.round(barSlot.w*Cw/PW), pbh=Math.max(2,Math.round(barSlot.h*Ch/PH));
      ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(pbx, pby+2, pbw, pbh);
      ctx.fillStyle='#000'; ctx.fillRect(pbx, pby, pbw, pbh);

      // Progreso y tiempos
      var p=0, cur='0:00', dur='0:00';
      if(audio && audio.duration>0){ p=audio.currentTime/audio.duration; cur=mmss(audio.currentTime); dur=mmss(audio.duration); }
      var fw=Math.max(2, Math.floor(pbw*p));
      var grad=ctx.createLinearGradient(pbx,0,pbx+fw,0);
      grad.addColorStop(0, (CFG.colors && CFG.colors.wave1)||'#13d77a');
      grad.addColorStop(1, (CFG.colors && CFG.colors.wave2)||'#ffd54a');
      ctx.fillStyle=grad; ctx.fillRect(pbx, pby, fw, pbh);

      var kx=pbx+fw, ky=pby+pbh/2, r=Math.max(3, Math.round(pbh*0.9/2));
      ctx.beginPath(); ctx.arc(kx,ky,r,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
      ctx.fillStyle='#000'; ctx.textBaseline='alphabetic'; ctx.textAlign='left';
      ctx.font='700 '+Math.round(28*Cw/2048)+'px system-ui,Segoe UI,Roboto';
      ctx.fillText(cur, pbx, pby - 10);
      ctx.textAlign='right'; ctx.fillText(dur, pbx+pbw, pby - 10);

      // Espectro
      var arr=null;
      if(analyser){ arr=new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr); }

      var step=pbw/BARS, yTop=pby - gap, yBot=pby + pbh + gap;
      var t = performance.now();
      var sweepX = pbx + ((Math.sin(t/900)+1)/2)*pbw;

      for(var pass=0; pass<2; pass++){
        var baseY = (pass===0? yTop : yBot);
        var col = (pass===0? ((CFG.colors && CFG.colors.wave1)||'#13d77a') : ((CFG.colors && CFG.colors.wave2)||'#ffd54a'));

        for(var i=0;i<BARS;i++){
          var bandIndex = arr ? Math.min(arr.length-1, 2+i) : 0;
          var raw = arr ? (arr[bandIndex]/255) : (0.25 + 0.75*Math.abs(Math.sin((t/420)+(i*0.35))));
          levels[i] = Math.max(raw*0.9 + levels[i]*0.1, levels[i]-0.012);
          peaks[i]  = Math.max(peaks[i]-0.006, levels[i]);

          var x = Math.round(pbx + i*step + step*0.18);
          var w = Math.max(2, Math.round(step*0.64));
          var h = Math.max(3, Math.round(levels[i]*waveH));
          var peakY = Math.max(4, Math.round(peaks[i]*waveH));

          var dist = Math.abs((x+w/2) - sweepX);
          var glow = Math.max(0, 1 - dist/120);

          ctx.fillStyle = col;
          if(pass===0) ctx.fillRect(x, baseY-h, w, h); else ctx.fillRect(x, baseY, w, h);

          // peak-hold
          ctx.globalAlpha = 0.7; ctx.fillStyle = '#000';
          if(pass===0) ctx.fillRect(x, baseY-peakY-2, w, 2);
          else         ctx.fillRect(x, baseY+peakY,   w, 2);
          ctx.globalAlpha = 1;

          if(glow>0){
            var g = ctx.createLinearGradient(x,0,x+w,0);
            g.addColorStop(0, 'rgba(255,255,255,'+(0.15*glow)+')');
            g.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = g;
            if(pass===0) ctx.fillRect(x, baseY-h, w, h);
            else         ctx.fillRect(x, baseY,   w, h);
          }
        }
      }

      // Cinta inferior
      var bandH = Math.round(50*Cw/2048);
      var yBand = Math.round((PH*0.88)*Ch/PH);
      var g2 = ctx.createLinearGradient(0,yBand,0,yBand+bandH);
      g2.addColorStop(0,'rgba(0,0,0,0.06)'); g2.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g2; ctx.fillRect(0,yBand,Cw,bandH);

      if(overlay.__tex) overlay.__tex.needsUpdate = true;
      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    /* ---------- Corazones con f√≠sica + drag ---------- */
    // ===== Corazones con F√çSICA DE CONTACTO + DRAG + CHISPAS =====
(function(){
  var HEART_SVG='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><path fill="%23ff3b61" d="M47.5 6c-5 0-8.8 3-15.5 10C25.3 9 21.5 6 16.5 6 9 6 4 11.8 4 19.2 4 33.7 23.1 43.4 32 58c8.9-14.6 28-24.3 28-38.8C60 11.8 55 6 47.5 6z"/></svg>';

  // zona de juego (banda inferior del p√≥ster, ajusta si quieres)
  var area={ x1:-0.5+0.06, x2:0.5-0.06, y1:-H/2+0.10, y2:-H/2+0.55 };

  var hearts=[]; // {el,x,y,vx,vy,ax,ay,r,m,ang,w}
  var MAX_HEARTS=28;
  var HEART_SIZE=0.11; // ancho/alto en metros del plano (‚âà11 cm en AR)
  var HEART_R=HEART_SIZE*0.5;

  // par√°metros f√≠sicos
  var GRAVITY_Y=-0.9;
  var LINEAR_DAMP=0.995;     // rozamiento aire
  var RESTITUTION=0.58;      // rebote
  var FRICTION_WALL=0.02;    // peque√±a p√©rdida tangencial en paredes
  var ANG_DAMP=0.992;        // freno de giro

  // plano invisible para raycast de drag (si ya lo ten√≠as, vale este)
  var dragPlane=document.createElement('a-plane');
  dragPlane.classList.add('dragplane');
  dragPlane.setAttribute('width',1);
  dragPlane.setAttribute('height',H);
  dragPlane.setAttribute('position','0 0 0.07');
  dragPlane.setAttribute('material','color:#fff; transparent:true; opacity:0; side:double; depthTest:false; depthWrite:false');
  root.appendChild(dragPlane); setRO(dragPlane, 150, false, false);

  function createSpark(x,y){
    var s=document.createElement('a-plane');
    s.setAttribute('width',0.06); s.setAttribute('height',0.06);
    s.setAttribute('position', x+' '+y+' 0.061');
    s.setAttribute('material','shader:flat; color:#ffffff; transparent:true; opacity:0.9; side:double');
    s.setAttribute('animation__fade','property:material.opacity; to:0; dur:240; easing:linear');
    s.setAttribute('rotation','0 0 0');
    root.appendChild(s); setRO(s, 145, false, false);
    setTimeout(function(){ s.remove(); }, 260);
  }

  function spawnHeart(x,y,sz){
    if(typeof x!=='number') x=(area.x1+area.x2)/2;
    if(typeof y!=='number') y=area.y2-0.05;
    if(typeof sz!=='number') sz=HEART_SIZE;

    var r=sz*0.5, m=r*r; // masa ~ √°rea
    var h=document.createElement('a-image');
    h.setAttribute('src',HEART_SVG);
    h.setAttribute('width',sz); h.setAttribute('height',sz);
    h.setAttribute('position', x+' '+y+' 0.06');
    h.setAttribute('material','transparent:true; alphaTest:0.01; side:double');
    h.classList.add('ui3d','heart');
    root.appendChild(h); setRO(h, 140, false, false);

    hearts.push({
      el:h, x:x, y:y,
      vx:(Math.random()-0.5)*0.15,
      vy:0.35+Math.random()*0.18,
      ax:0, ay:0, r:r, m:m,
      ang: (Math.random()*360),
      w: (Math.random()-0.5)*60 // vel. angular (grados/s)
    });

    if(hearts.length>MAX_HEARTS){ var old=hearts.shift(); old.el.remove(); }
  }

  // ‚Äî‚Äî utilidades drag ‚Äî‚Äî
  function getRay(){
    var rayEnt=document.getElementById('mouseRay');
    return rayEnt && rayEnt.components ? rayEnt.components.raycaster : null;
  }
  function pointerLocal(){
    var ray=getRay(); var ints = (ray && ray.intersections) ? ray.intersections : [];
    var hit=null;
    for(var i=0;i<ints.length;i++){
      var it=ints[i];
      if(it.object && it.object.el && it.object.el.classList && it.object.el.classList.contains('dragplane')){ hit=it; break; }
    }
    if(!hit) return null;
    var p=hit.point.clone();
    root.object3D.worldToLocal(p);
    if(p.x<area.x1) p.x=area.x1; if(p.x>area.x2) p.x=area.x2;
    if(p.y<area.y1) p.y=area.y1; if(p.y>area.y2) p.y=area.y2;
    return {x:p.x,y:p.y};
  }
  function heartFromEl(el){
    for(var i=0;i<hearts.length;i++){ if(hearts[i].el===el) return hearts[i]; }
    return null;
  }

  var dragging=null, dragOffset={x:0,y:0}, lastPointer=null, lastTime=0;

  function onPointerDown(){
    var ray=getRay(); var ints = (ray && ray.intersections) ? ray.intersections : [];
    var hitHeart=null;
    for(var i=0;i<ints.length;i++){
      var it=ints[i];
      if(it.object && it.object.el && it.object.el.classList && it.object.el.classList.contains('heart')){ hitHeart=it; break; }
    }
    var p=pointerLocal();

    if(hitHeart && p){
      var h=heartFromEl(hitHeart.object.el); if(!h) return;
      dragging=h; dragOffset={x:h.x-p.x, y:h.y-p.y};
      lastPointer=p; lastTime=performance.now();
      return;
    }
    // Tap en vac√≠o: crea un coraz√≥n
    if(p){ spawnHeart(p.x,p.y, HEART_SIZE*(0.9+Math.random()*0.25)); }
  }
  function onPointerUp(){ dragging=null; }

  var sceneEl=document.getElementById('scene');
  sceneEl.addEventListener('mousedown', onPointerDown);
  sceneEl.addEventListener('mouseup', onPointerUp);
  sceneEl.addEventListener('mouseleave', onPointerUp);
  sceneEl.addEventListener('touchstart', onPointerDown, {passive:true});
  sceneEl.addEventListener('touchend', onPointerUp, {passive:true});
  sceneEl.addEventListener('touchcancel', onPointerUp, {passive:true});

  // ‚Äî‚Äî integrador + colisiones entre corazones ‚Äî‚Äî
  function solvePair(a,b){
    var dx=b.x-a.x, dy=b.y-a.y;
    var distSq=dx*dx+dy*dy;
    var minDist=a.r+b.r;
    if(distSq<=0) return;
    var dist=Math.sqrt(distSq);
    if(dist>=minDist) return;

    // normal
    var nx=dx/dist, ny=dy/dist;
    var overlap=minDist-dist;

    // separar (posici√≥n) mitad y mitad
    var k=0.5;
    a.x-=nx*overlap*k; a.y-=ny*overlap*k;
    b.x+=nx*overlap*k; b.y+=ny*overlap*k;

    // impulso (colisi√≥n el√°stica amortiguada)
    var rvx=b.vx-a.vx, rvy=b.vy-a.vy;
    var relVel = rvx*nx + rvy*ny;
    if(relVel>0) return; // ya se separan

    var e=RESTITUTION;
    var j=-(1+e)*relVel/(1/a.m + 1/b.m);
    var jx= j*nx, jy= j*ny;

    a.vx -= jx/a.m; a.vy -= jy/a.m;
    b.vx += jx/b.m; b.vy += jy/b.m;

    // giro por fricci√≥n aproximada
    a.w -= (jy*0.5 - jx*0.5)*20;
    b.w += (jy*0.5 - jx*0.5)*20;

    // chispita en choques fuertes
    if(j>0.35){ createSpark(a.x+nx*a.r, a.y+ny*a.r); }
  }

  function physicsTick(){
    var dt=1/60;

    // drag activo (spring suave)
    var p=pointerLocal();
    if(dragging && p){
      var nx=p.x+dragOffset.x, ny=p.y+dragOffset.y;
      var now=performance.now();
      var dtms=Math.max(16, now-lastTime);
      // velocidad aproximada basada en desplazamiento
      dragging.vx=(nx-dragging.x)/(dtms/1000);
      dragging.vy=(ny-dragging.y)/(dtms/1000);
      // seguir dedo (semi-stiff)
      dragging.x = dragging.x*0.35 + nx*0.65;
      dragging.y = dragging.y*0.35 + ny*0.65;
      lastPointer=p; lastTime=now;
    }

    // integrar + paredes
    for(var i=0;i<hearts.length;i++){
      var h=hearts[i];
      if(h!==dragging){
        h.vy += GRAVITY_Y*dt;
        h.vx *= LINEAR_DAMP; h.vy *= LINEAR_DAMP;
        h.x  += h.vx*dt;     h.y  += h.vy*dt;
      }

      // paredes (con fricci√≥n tangencial)
      if(h.x-h.r<area.x1){ h.x=area.x1+h.r; h.vx*=-RESTITUTION; h.vy*=1-FRICTION_WALL; h.w*=-ANG_DAMP; }
      if(h.x+h.r>area.x2){ h.x=area.x2-h.r; h.vx*=-RESTITUTION; h.vy*=1-FRICTION_WALL; h.w*=-ANG_DAMP; }
      if(h.y-h.r<area.y1){ h.y=area.y1+h.r; h.vy*=-RESTITUTION; h.vx*=1-FRICTION_WALL; h.w*=-ANG_DAMP; }
      if(h.y+h.r>area.y2){ h.y=area.y2-h.r; h.vy*=-RESTITUTION; h.vx*=1-FRICTION_WALL; h.w*=-ANG_DAMP; }

      // giro
      h.w *= ANG_DAMP;
      h.ang += h.w*dt;

      // render
      h.el.setAttribute('position', h.x+' '+h.y+' 0.06');
      h.el.setAttribute('rotation', '0 0 '+h.ang);
    }

    // colisiones O(n^2) (r√°pido para < 40)
    for(var i2=0;i2<hearts.length;i2++){
      for(var j2=i2+1;j2<hearts.length;j2++){
        solvePair(hearts[i2], hearts[j2]);
      }
    }

    requestAnimationFrame(physicsTick);
  }
  requestAnimationFrame(physicsTick);

  // corazones de bienvenida al encontrar target (si ya lo tienes, ignora)
  // for(var i0=0;i0<4;i0++) spawnHeart();
  // ===== FIN bloque corazones =====
})();

    /* ---------- Bot√≥n c√°mara robusto ---------- */
    function ensureSceneLoaded(){
      return new Promise(function(res){
        if(scene.hasLoaded){ res(); return; }
        scene.addEventListener('loaded', function(){ res(); }, {once:true});
      });
    }
    function ensureMindARReady(){
      return new Promise(function(res){
        if(scene.components['mindar-image']){ res(); return; }
        function onInit(e){
          if(e.detail && e.detail.name==='mindar-image'){
            scene.removeEventListener('componentinitialized', onInit);
            res();
          }
        }
        scene.addEventListener('componentinitialized', onInit);
      });
    }
    function startMindAR(){
      var comp=scene.components['mindar-image'];
      var sys =scene.systems['mindar-image-system'];
      if(comp && typeof comp.start==='function'){ return comp.start(); }
      if(sys && typeof sys.start==='function'){ return sys.start(); }
      return Promise.reject(new Error('No MindAR start method'));
    }

    var btnStart=document.getElementById('btnStart');
    btnStart.addEventListener('click', function(){
      btnStart.disabled=true;
      log('Pidiendo c√°mara‚Ä¶');
      navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false})
        .then(function(s){
          s.getTracks().forEach(function(t){ t.stop(); });
          return ensureSceneLoaded();
        })
        .then(ensureMindARReady)
        .then(startMindAR)
        .then(function(){
          btnStart.textContent='C√°mara lista';
          log('C√°mara iniciada');
        })
        .catch(function(e){
          btnStart.disabled=false;
          log('No se pudo iniciar la c√°mara ('+(e.name||'')+' '+(e.message||e)+')');
        });
    });

    anchor.addEventListener('targetFound', function(){
      v1.play().then(function(){ setTimeout(checkBlackFallback, 200); }).catch(function(){});
      setupAudio();
      try{
        if(acx && acx.state==='suspended'){ acx.resume().then(function(){ audio.play().catch(function(){}); }); }
        else if(audio){ audio.play().catch(function(){}); }
      }catch(e){}
      document.getElementById('btnAudio').disabled=false;
      for(var i=0;i<4;i++) spawnHeart();
      log('Target FOUND');
    });

    anchor.addEventListener('targetLost', function(){
      try{ v1.pause(); }catch(e){}
      if(audio){ try{ audio.pause(); }catch(e){} btnAudio.textContent='‚ñ∂Ô∏è Audio'; }
      log('Target LOST‚Ä¶');
    });

    // auto-arranque con primer gesto (iOS)
    window.addEventListener('pointerup', function(){
      try{ v1.play(); }catch(e){}
      btnStart.click();
    }, {once:true,passive:true});

  }).catch(function(e){
    log('‚ùó No pude cargar el JSON: '+(e.message||e));
  });
})();
</script>
</body>
</html>
