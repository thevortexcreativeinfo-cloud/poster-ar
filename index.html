<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR ¬∑ Safe</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* C√°mara en cover detr√°s del canvas */
  video[playsinline]{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important}
  a-scene{position:fixed!important;inset:0!important;z-index:2!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:none}
  .ui{position:fixed;inset:0;display:flex;align-items:flex-start;gap:10px;padding:10px;z-index:4;pointer-events:none}
  .btn{pointer-events:auto;border:1px solid #2a3a58;background:#0e1422;color:#eaf2ff;
       border-radius:12px;padding:10px 14px;font:14px/1.2 system-ui}
  .dbg{margin-left:auto;pointer-events:none;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;font:12px/1.4 system-ui,Segoe UI,Roboto;color:#cfe3ff;max-width:60vw}
  .ok{color:#7de0ca}.warn{color:#ffce7a}.err{color:#ff9a9a}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn">üì∑ Abrir c√°mara</button>
  <button id="btnSound" class="btn" hidden>üîä Activar sonido</button>
  <div id="dbg" class="dbg">Cargando‚Ä¶</div>
</div>

<a-scene id="scene"
  embedded vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:true"
  renderer="alpha:true;antialias:true;logarithmicDepthBuffer:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: yes; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.001;"
  style="width:100vw;height:100vh">

  <a-assets id="assets" timeout="60000">
    <img id="overlayImg" crossorigin="anonymous"/>
    <video id="v1" playsinline webkit-playsinline muted loop preload="auto" crossorigin="anonymous"></video>
    <video id="v2" playsinline webkit-playsinline muted loop preload="auto" crossorigin="anonymous"></video>
    <video id="v3" playsinline webkit-playsinline muted loop preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(function(){
  const dbg = document.getElementById('dbg');
  const btnStart = document.getElementById('btnStart');
  const btnSound = document.getElementById('btnSound');
  const log = (m,cls='')=>{ dbg.innerHTML=(cls?`<span class="${cls}">${m}</span>`:m)+'<br>'+dbg.innerHTML; console.log('[AR]',m); };
  window.onerror=(msg,src,line,col)=>log('JS ERROR: '+msg+' @'+line+':'+col,'err');

  const q = new URLSearchParams(location.search);
  const t  = q.get('t') || '';
  const d  = q.get('d') || '';
  const pw = +(q.get('pw')||2481), ph=+(q.get('ph')||3508), H=ph/pw;
  const dx = +(q.get('dx')||0), dy=+(q.get('dy')||0), sc=+(q.get('scale')||1), rot=+(q.get('rot')||0);
  const overlayDebug = q.get('overlayDebug')==='1';

  const vSlots=[1,2,3].map(i=>({id:i,v:q.get('v'+i),x:+q.get('x'+i)||0,y:+q.get('y'+i)||0,w:+q.get('vw'+i)||0,h:+q.get('vh'+i)||0}))
    .filter(s=>s.v&&s.w>0&&s.h>0);

  // Textos con el componente "text" de A-Frame (sencillo y fiable)
  const tSlots=[1,2,3,4,5].map(i=>{
    const val=q.get('t'+i); if(!val) return null;
    return {id:i,text:val,x:+q.get('xt'+i)||0,y:+q.get('yt'+i)||0,w:+q.get('wt'+i)||0,h:+q.get('ht'+i)||0,
            align:(q.get('ta'+i)||'center'),color:'#'+(q.get('tc'+i)||'000000')};
  }).filter(Boolean);

  const audioSrc=q.get('audio')||'';
  let audioEl=null, userApproved=false, targetVisible=false;
  if(audioSrc){ audioEl=new Audio(audioSrc); audioEl.crossOrigin='anonymous'; audioEl.preload='auto'; }

  if(!t){ log('‚ùó Falta ?t=<URL .mind>','err'); return; }
  const scene=document.getElementById('scene');
  scene.setAttribute('mindar-image', `imageTargetSrc: ${t}; uiLoading: yes; autoStart: false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.001;`);
  scene.addEventListener('loaded', ()=>{ try{ scene.renderer.setClearColor(0x000000,0); }catch(e){} });

  // Forzar cover para el <video srcObject> de la c√°mara
  const mo=new MutationObserver(()=>{
    document.querySelectorAll('video').forEach(v=>{
      if(v.srcObject instanceof MediaStream){
        v.style.objectFit='cover'; v.style.width='100vw'; v.style.height='100vh';
        v.style.position='fixed'; v.style.inset='0'; v.style.zIndex='0';
      }
    });
  }); mo.observe(document.documentElement,{subtree:true,childList:true});

  // ===== Build =====
  const assets=document.getElementById('assets');
  const overlayImg=document.getElementById('overlayImg');
  if(d) overlayImg.src=d;
  const videos={1:document.getElementById('v1'),2:document.getElementById('v2'),3:document.getElementById('v3')};
  vSlots.forEach(s=>{ videos[s.id].src=s.v; });

  const anchor=document.getElementById('anchor');
  const pxToUnits=(x,y,w,h)=>({wn:w/pw,hn:h/pw,cx:-0.5+(x+w/2)/pw,cy:(ph/pw)/2-(y+h/2)/pw});

  const root=document.createElement('a-entity');
  root.setAttribute('position', `${dx/pw} ${-dy/pw} 0`);
  root.setAttribute('scale', `${sc} ${sc} 1`);
  if(rot) root.setAttribute('rotation',`0 0 ${rot}`);
  anchor.appendChild(root);

  // Overlay
  const overlay=document.createElement('a-plane');
  overlay.setAttribute('width',1); overlay.setAttribute('height',H);
  overlay.setAttribute('position','0 0 0.00');
  overlay.setAttribute('material','shader:flat; transparent:true; side:double; depthTest:false; opacity:1');
  overlay.addEventListener('loaded',()=>{
    const mesh=overlay.getObject3D('mesh'); if(!mesh) return; mesh.renderOrder=10;
  });
  root.appendChild(overlay);

  if(overlayDebug || !d){
    overlay.addEventListener('loaded',()=>{ const m=overlay.getObject3D('mesh').material; m.color.set('#00ffaa'); m.opacity=0.25; });
  }else{
    overlay.setAttribute('material','shader:flat; src:#overlayImg; transparent:true; side:double; depthTest:false; opacity:1');
  }

  // V√≠deos
  vSlots.forEach(s=>{
    const {wn,hn,cx,cy}=pxToUnits(s.x,s.y,s.w,s.h);
    const vp=document.createElement('a-plane');
    vp.setAttribute('width',wn); vp.setAttribute('height',hn);
    vp.setAttribute('position',`${cx} ${cy} 0.03`);
    vp.setAttribute('material',`shader:flat; src:#v${s.id}; side:double; depthTest:false; opacity:1`);
    vp.addEventListener('loaded',()=>{ const mesh=vp.getObject3D('mesh'); if(mesh) mesh.renderOrder=20; });
    // COVER
    function cover(){ const mesh=vp.getObject3D('mesh'), v=videos[s.id]; if(!mesh||!mesh.material||!mesh.material.map||!v||!v.videoWidth) return;
      const tex=mesh.material.map, vr=v.videoWidth/v.videoHeight, rr=s.w/s.h; let rx=1,ry=1,ox=0,oy=0;
      if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
      tex.offset.set(ox,oy); tex.repeat.set(rx,ry); tex.needsUpdate=true; mesh.material.needsUpdate=true;
    }
    vp.addEventListener('materialtextureloaded',cover);
    videos[s.id].addEventListener('loadedmetadata',()=>{ videos[s.id].play().catch(()=>{}); cover(); }, {once:true});
    root.appendChild(vp);
  });

  // Textos (A-Frame text)
  tSlots.forEach(s=>{
    const {wn,hn,cx,cy}=pxToUnits(s.x,s.y,s.w,s.h);
    const te=document.createElement('a-entity');
    te.setAttribute('position', `${cx} ${cy} 0.12`);
    te.setAttribute('text', `value:${s.text}; color:${s.color}; align:${s.align}; anchor:center; baseline:center; width:${wn}; wrapCount:60;`);
    te.setAttribute('material','transparent:true; opacity:1; depthTest:false; side:double');
    te.addEventListener('loaded',()=>{ const obj=te.getObject3D('text'); const mesh=te.getObject3D('mesh')||te.getObject3D('text'); if(mesh) mesh.renderOrder=30; });
    root.appendChild(te);
  });

  // ===== Eventos AR / Audio =====
  function tryStartAudio(){
    if(!audioEl) return;
    if(targetVisible && userApproved){ audioEl.play().catch(()=>{}); btnSound.hidden=true; }
    else { audioEl.pause(); if(targetVisible && !userApproved) btnSound.hidden=false; }
  }
  btnSound.onclick=()=>{ userApproved=true; tryStartAudio(); };

  anchor.addEventListener('targetFound', ()=>{
    targetVisible=true;
    Object.values(videos).forEach(v=>v && v.play && v.play().catch(()=>{}));
    tryStartAudio();
    log('Target FOUND','ok');
  });
  anchor.addEventListener('targetLost', ()=>{
    targetVisible=false;
    Object.values(videos).forEach(v=>v && v.pause && v.pause());
    if(audioEl) audioEl.pause();
    if(audioEl && userApproved) btnSound.hidden=false;
    log('Target LOST','warn');
  });

  scene.addEventListener('arReady', ()=>log('C√°mara OK','ok'));
  scene.addEventListener('arError', e=>log('Error c√°mara/permisos '+(e?.detail||''),'err'));

  // Bot√≥n Abrir c√°mara (evita bloqueos)
  btnStart.onclick=async()=>{
    try{
      await scene.systems['mindar-image-system'].start();
      log('C√°mara iniciada','ok');
      btnStart.disabled=true; btnStart.textContent='C√°mara lista';
    }catch(e){ log('No se pudo iniciar c√°mara: '+e,'err'); }
  };

  // Primer toque: habilitar v√≠deos si el navegador lo exige
  window.addEventListener('touchend', ()=>{ Object.values(videos).forEach(v=>v && v.play && v.play().catch(()=>{})); }, {once:true,passive:true});
})();
</script>
</body>
</html>
