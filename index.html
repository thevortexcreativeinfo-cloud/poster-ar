<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR ¬∑ Universal</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* C√°mara detr√°s */
  video[playsinline]{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important}
  /* WebGL delante */
  a-scene{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:auto!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:4!important;pointer-events:auto!important}
  /* UI */
  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.3 system-ui;z-index:8;pointer-events:none;opacity:.16;transition:opacity .35s}
  .dbg:hover{opacity:1}
  .overlayNote{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:9;
    background:#0f1522cc;color:#cfe3ff;border:1px solid #22324d;border-radius:12px;padding:8px 12px;font:13px/1.3 system-ui;display:none}
  .overlayNote.show{display:block}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button">üì∑ Abrir c√°mara</button>
  <button id="btnAudio" class="btn" type="button" disabled>‚ñ∂Ô∏è Audio</button>
</div>
<div id="dbg" class="dbg">Listo‚Ä¶</div>
<div id="hint" class="overlayNote">Apunta al p√≥ster para empezar</div>

<a-scene id="scene"
  embedded
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:true"
  renderer="alpha:true; antialias:false; sortTransparentObjects:true; logarithmicDepthBuffer:false"
  loading-screen="enabled:false"
  mindar-image="uiLoading:false; uiScanning:false; autoStart:false; maxTrack:1;
                warmupTolerance:3; missTolerance:6; filterMinCF:0.0015; filterBeta:0.005;"
  style="width:100vw;height:100vh">

  <a-assets timeout="60000">
    <!-- ¬°OJO! Sin src inicial para evitar about:blank/CORS -->
    <video id="v1" playsinline webkit-playsinline muted autoplay loop preload="metadata" crossorigin="anonymous"></video>
  </a-assets>

  <a-camera id="cam" look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async function(){
  const qs  = new URLSearchParams(location.search);
  const log = m => { const el=document.getElementById('dbg'); el.textContent = m+' ¬∑ '+new Date().toLocaleTimeString(); el.style.opacity=.9; setTimeout(()=>el.style.opacity=.16,1200); console.log('[AR]',m); };

  // Mantener el <video> de la c√°mara detr√°s en cover
  new MutationObserver(()=>{ document.querySelectorAll('video').forEach(v=>{
    if(v.srcObject instanceof MediaStream){
      Object.assign(v.style,{objectFit:'cover',position:'fixed',inset:'0',width:'100vw',height:'100vh',zIndex:'0',background:'#000'});
    }
  });}).observe(document.documentElement,{subtree:true,childList:true});

  /* ---------- Cargar CFG + PRE-CARGAR TARGET (.mind) COMO BLOB ---------- */
  const cfgUrl = qs.get('cfg');
  if(!cfgUrl){ log('Falta ?cfg=URL_DEL_JSON'); return; }

  let CFG;
  try{ CFG = await (await fetch(cfgUrl,{mode:'cors',cache:'no-store'})).json(); }
  catch(e){ log('‚ùó No pude cargar el JSON'); return; }

  // Pre-carga del .mind ‚Üí Blob URL (evita CORS y bloqueos del UI nativo)
  let targetURL = null;
  try{
    const r = await fetch(CFG.target, {mode:'cors',cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const blob = await r.blob();
    targetURL = URL.createObjectURL(blob);
  }catch(e){
    log('‚ùó No pude cargar el target .mind ('+(e.message||e)+')');
    // seguimos con la URL original como fallback
    targetURL = CFG.target;
  }

  const scene  = document.getElementById('scene');
  const anchor = document.getElementById('anchor');
  const hint   = document.getElementById('hint');

  // Inyectar el imageTargetSrc ya resuelto
  scene.setAttribute('mindar-image',
    `imageTargetSrc:${targetURL}; uiLoading:false; uiScanning:false; autoStart:false; maxTrack:1; warmupTolerance:3; missTolerance:6; filterMinCF:0.0015; filterBeta:0.005;`
  );

  /* ---------- P√≥ster / v√≠deo m√≠nimo (lo esencial para esta correcci√≥n) ---------- */
  const PW=CFG.pw||2481, PH=CFG.ph||3508, H=PH/PW;
  const px2=(x,y,w,h)=>({wn:w/PW, hn:h/PW, cx:-0.5+(x+w/2)/PW, cy:H/2-(y+h/2)/PW});
  const cal=Object.assign({dx:0,dy:0,scale:1,rot:0}, CFG.cal||{});

  const root=document.createElement('a-entity'); anchor.appendChild(root);
  root.setAttribute('position', `${cal.dx/PW} ${-cal.dy/PW} 0`);
  root.setAttribute('scale', `${cal.scale} ${cal.scale} 1`);
  root.setAttribute('rotation', `0 0 ${cal.rot}`);

  function setRO(el, order, depthTest, depthWrite){
    el.addEventListener('loaded', ()=>{
      const mesh = el.getObject3D('mesh'); if(!mesh) return;
      mesh.renderOrder = order;
      if(mesh.material){ mesh.material.depthTest=!!depthTest; mesh.material.depthWrite=!!depthWrite; mesh.material.needsUpdate=true; }
    });
  }

  const paper=document.createElement('a-plane');
  paper.setAttribute('width',1); paper.setAttribute('height',H);
  paper.setAttribute('position','0 0 -0.02');
  paper.setAttribute('material','shader:flat; color:#ffffff; side:double');
  root.appendChild(paper); setRO(paper, 1, false, false);

  // Marco simple
  const vslot=CFG.slotVid, u=px2(vslot.x,vslot.y,vslot.w,vslot.h);
  const frame=document.createElement('a-plane');
  frame.setAttribute('width',u.wn*1.04);
  frame.setAttribute('height',u.hn*1.04);
  frame.setAttribute('position',`${u.cx} ${u.cy} 0.018`);
  frame.setAttribute('material','shader:flat; color:#e9eef2; side:double');
  root.appendChild(frame); setRO(frame, 60, false, false);

  // V√≠deo
  const v1=document.getElementById('v1');
  v1.crossOrigin='anonymous';
  v1.muted=true; v1.playsInline=true;
  v1.setAttribute('playsinline','true'); v1.setAttribute('webkit-playsinline','true');
  v1.src = CFG.video || '';
  v1.load();

  const vPlane=document.createElement('a-plane');
  vPlane.setAttribute('width',u.wn);
  vPlane.setAttribute('height',u.hn);
  vPlane.setAttribute('position',`${u.cx} ${u.cy} 0.02`);
  vPlane.setAttribute('material','shader:flat; side:double; src:#v1');
  root.appendChild(vPlane); setRO(vPlane, 100, true, true);

  function coverFromMap(map){
    if(!map || !v1.videoWidth) return;
    const vr=v1.videoWidth/v1.videoHeight, rr=vslot.w/vslot.h;
    let rx=1,ry=1,ox=0,oy=0;
    if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
    map.offset.set(ox,oy); map.repeat.set(rx,ry); map.needsUpdate=true;
  }
  vPlane.addEventListener('materialtextureloaded', e=>coverFromMap(e.detail.texture));
  v1.addEventListener('loadedmetadata', ()=>coverFromMap(vPlane.getObject3D('mesh')?.material?.map));

  let forcedVideoTex=false;
  function forceThreeVideoTexture(){
    if(forcedVideoTex) return;
    const mesh=vPlane.getObject3D('mesh'); if(!mesh) return;
    const tex=new AFRAME.THREE.VideoTexture(v1);
    tex.needsUpdate=true;
    mesh.material.map=tex; mesh.material.needsUpdate=true;
    coverFromMap(tex);
    forcedVideoTex=true;
    log('Fallback a THREE.VideoTexture');
  }
  function checkBlackFallback(){
    const mesh=vPlane.getObject3D('mesh');
    const map=mesh?.material?.map;
    if(!v1.videoWidth || !map) forceThreeVideoTexture();
  }

  /* ---------- Arranque MindAR con fallbacks y watchdog ---------- */
  async function waitSceneLoaded(){ if(scene.hasLoaded) return; await new Promise(r=>scene.addEventListener('loaded',r,{once:true})); }
  async function waitMindARReady(){
    if(scene.components['mindar-image']) return;
    await new Promise(res=>{
      function onInit(e){ if(e.detail?.name==='mindar-image'){ scene.removeEventListener('componentinitialized', onInit); res(); } }
      scene.addEventListener('componentinitialized', onInit);
    });
  }
  async function startMindAROnce(){
    const comp=scene.components['mindar-image'];
    const sys =scene.systems['mindar-image-system'];
    if(sys?.active) return;
    if(comp?.start) return comp.start();
    if(sys?.start)  return sys.start();
    throw new Error('No MindAR start method');
  }

  async function tryOpenCamera(){
    const attempts = [
      { video:{ facingMode:{ideal:'environment'}, width:{ideal:960,max:1280}, height:{ideal:540,max:720}, frameRate:{ideal:30,max:30} }, audio:false },
      { video:{ facingMode:'environment' }, audio:false },
      { video:{ facingMode:'user' }, audio:false },
      { video:true, audio:false }
    ];
    let lastErr=null;
    for(const c of attempts){
      try{
        const s=await navigator.mediaDevices.getUserMedia(c);
        s.getTracks().forEach(t=>t.stop());
        return true;
      }catch(e){ lastErr=e; }
    }
    throw lastErr || new Error('No camera available');
  }

  // Eventos MindAR para diagnosticar el ‚Äúloading‚Äù
  scene.addEventListener('arReady', ()=>{ log('MindAR listo'); hint.classList.add('show'); setTimeout(()=>hint.classList.remove('show'), 1800); });
  scene.addEventListener('arError', (e)=>{ log('MindAR ERROR: '+(e.detail?.message||'')); alert('No se pudo iniciar AR. Revisa permisos de c√°mara y vuelve a intentar.'); });

  const btnStart=document.getElementById('btnStart');

  btnStart.onclick=async()=>{
    try{
      btnStart.disabled=true; btnStart.textContent='Preparando‚Ä¶'; log('Pidiendo c√°mara‚Ä¶');

      // 1) Asegura permisos/disp. (con fallbacks)
      await tryOpenCamera();

      // 2) Carga escena + componente MindAR
      await waitSceneLoaded();
      await waitMindARReady();

      // 3) Start MindAR
      log('Iniciando detector‚Ä¶');
      await startMindAROnce();
      btnStart.textContent='Detectando‚Ä¶';

      // 4) Watchdog: si en 8s no llega arReady, reintenta una vez
      let ready = false, timer = setTimeout(async ()=>{
        if(ready) return;
        log('Watchdog: reintentando arranque‚Ä¶');
        try{ await startMindAROnce(); }catch(e){}
      }, 8000);
      scene.addEventListener('arReady', ()=>{ ready=true; clearTimeout(timer); btnStart.textContent='C√°mara lista'; }, {once:true});

    }catch(e){
      btnStart.disabled=false; btnStart.textContent='üì∑ Abrir c√°mara';
      log(`No se pudo iniciar la c√°mara/AR (${e.name||''} ${e.message||e})`);
      if(e && e.name==='NotFoundError'){
        alert('No se encontr√≥ c√°mara disponible o est√° en uso por otra app. Revisa permisos del navegador/OS.');
      }
    }
  };

  /* ---------- target events ---------- */
  anchor.addEventListener('targetFound', async ()=>{
    try{ await v1.play(); setTimeout(checkBlackFallback, 200); }catch{}
    hint.classList.remove('show');
    log('Target FOUND');
  });
  anchor.addEventListener('targetLost', ()=>{
    v1.pause();
    hint.textContent='Apunta al p√≥ster para continuar';
    hint.classList.add('show');
    log('Target LOST‚Ä¶');
  });

  // iOS: primer gesto ayuda a medios
  window.addEventListener('pointerup', ()=>{
    v1.play().catch(()=>{});
    if(!scene.systems['mindar-image-system']?.active) btnStart.click();
  }, {once:true,passive:true});

  // Limpieza del blob al salir
  window.addEventListener('unload', ()=>{ try{ targetURL && targetURL.startsWith('blob:') && URL.revokeObjectURL(targetURL); }catch{} });
})();
</script>
</body>
</html>
