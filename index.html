<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR ¬∑ Universal</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* C√°mara detr√°s */
  video[playsinline]{
    position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important
  }
  /* WebGL delante */
  a-scene{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:auto!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:4!important;pointer-events:auto!important}
  /* UI */
  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.3 system-ui;z-index:8;pointer-events:none;opacity:.16;transition:opacity .35s}
  .dbg:hover{opacity:1}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button">üì∑ Abrir c√°mara</button>
  <button id="btnAudio" class="btn" type="button" disabled>‚ñ∂Ô∏è Audio</button>
</div>
<div id="dbg" class="dbg">Cargando‚Ä¶</div>

<a-scene id="scene"
  embedded vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:true"
  renderer="alpha:true;antialias:true;logarithmicDepthBuffer:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;"
  style="width:100vw;height:100vh">

  <a-assets timeout="60000">
    <video id="v1" playsinline webkit-playsinline muted autoplay loop preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <a-camera id="cam" look-controls="enabled:false">
    <a-entity cursor="rayOrigin: mouse" raycaster="objects: .ui3d; far: 3"></a-entity>
  </a-camera>

  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async function(){
  const qs = new URLSearchParams(location.search);
  const log = m => { const el=document.getElementById('dbg'); el.textContent = m+' ¬∑ '+new Date().toLocaleTimeString(); el.style.opacity=.9; setTimeout(()=>el.style.opacity=.16,1200); console.log('[AR]',m); };

  /* ===== Cargar JSON ===== */
  const cfgUrl = qs.get('cfg');
  if(!cfgUrl){ alert('Falta ?cfg=URL_DEL_JSON'); return; }
  let CFG;
  try{ CFG = await (await fetch(cfgUrl,{mode:'cors',cache:'no-store'})).json(); }
  catch{ alert('No pude cargar el JSON de cliente'); return; }

  /* ===== Preparar escena MindAR ===== */
  const scene = document.getElementById('scene');
  scene.setAttribute('mindar-image',
    `imageTargetSrc:${CFG.target}; uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;`);

  // c√°mara en cover
  new MutationObserver(()=>{ document.querySelectorAll('video').forEach(v=>{
    if(v.srcObject instanceof MediaStream){
      Object.assign(v.style,{objectFit:'cover',position:'fixed',inset:'0',width:'100vw',height:'100vh',zIndex:'0',background:'#000'});
    }
  });}).observe(document.documentElement,{subtree:true,childList:true});

  const PW = CFG.pw||2481, PH = CFG.ph||3508, H=PH/PW;
  const px2 = (x,y,w,h)=>({wn:w/PW, hn:h/PW, cx:-0.5+(x+w/2)/PW, cy:H/2-(y+h/2)/PW});

  const anchor = document.getElementById('anchor');
  const root = document.createElement('a-entity'); anchor.appendChild(root);
  const cal = Object.assign({dx:0,dy:0,scale:1,rot:0}, CFG.cal||{});
  function applyCal(){
    root.setAttribute('position', `${cal.dx/PW} ${-cal.dy/PW} 0`);
    root.setAttribute('scale', `${cal.scale} ${cal.scale} 1`);
    root.setAttribute('rotation', `0 0 ${cal.rot}`);
  }
  applyCal();

  /* ===== Papel blanco (opaco) ===== */
  const paper = document.createElement('a-plane');
  paper.setAttribute('width',1); paper.setAttribute('height',H);
  paper.setAttribute('position','0 0 -0.01');
  paper.setAttribute('material','shader:flat; color:#ffffff; side:double; transparent:false; depthTest:false');
  root.appendChild(paper);

  /* ===== Marco + V√≠deo ===== */
  const v1 = document.getElementById('v1'); v1.src = CFG.video||'';
  const vslot = CFG.slotVid;
  const u = px2(vslot.x,vslot.y,vslot.w,vslot.h);

  // marco (doble borde) que SIEMPRE se ve
  (function makeFrame(){
    const outer = document.createElement('a-plane'); // sombra/borde exterior
    outer.setAttribute('width', u.wn*1.04); outer.setAttribute('height', u.hn*1.04);
    outer.setAttribute('position', `${u.cx} ${u.cy} 0.02`);
    outer.setAttribute('material','shader:flat; color:#0b0b0b; opacity:0.95; side:double');
    root.appendChild(outer);

    const inner = document.createElement('a-plane'); // filete interior
    inner.setAttribute('width', u.wn*1.00); inner.setAttribute('height', u.hn*1.00);
    inner.setAttribute('position', `${u.cx} ${u.cy} 0.025`);
    inner.setAttribute('material','shader:flat; color:#dfe9ef; opacity:1; side:double');
    root.appendChild(inner);
  })();

  const vPlane=document.createElement('a-plane'); // v√≠deo (encima del marco)
  vPlane.setAttribute('width',u.wn); vPlane.setAttribute('height',u.hn);
  vPlane.setAttribute('position',`${u.cx} ${u.cy} 0.03`);
  vPlane.setAttribute('material','shader:flat; src:#v1; side:double; depthTest:true; opacity:1');
  root.appendChild(vPlane);

  function coverVideo(){
    const mesh=vPlane.getObject3D('mesh'); if(!mesh||!mesh.material||!mesh.material.map||!v1.videoWidth) return;
    const tex=mesh.material.map, vr=v1.videoWidth/v1.videoHeight, rr=vslot.w/vslot.h;
    let rx=1,ry=1,ox=0,oy=0;
    if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
    tex.offset.set(ox,oy); tex.repeat.set(rx,ry); tex.needsUpdate=true;
    vPlane.__base = {ox,oy,rx,ry,tex};
  }
  vPlane.addEventListener('materialtextureloaded', coverVideo);
  v1.addEventListener('loadedmetadata', ()=>{ v1.play().catch(()=>{}); coverVideo(); }, {once:true});

  /* ===== Canvas overlay (textos + barra) detr√°s del v√≠deo ===== */
  const Cw = 2048, Ch = Math.round(Cw*H);
  const canvas = document.createElement('canvas'); canvas.width=Cw; canvas.height=Ch;
  const ctx = canvas.getContext('2d');

  const overlayP = document.createElement('a-plane');
  overlayP.setAttribute('width',1); overlayP.setAttribute('height',H);
  overlayP.setAttribute('position','0 0 0.0');  // detr√°s del v√≠deo
  overlayP.setAttribute('material','shader:flat; transparent:true; side:double; depthTest:false; opacity:1');
  root.appendChild(overlayP);
  overlayP.addEventListener('loaded', ()=>{ const tex = new AFRAME.THREE.CanvasTexture(canvas); const m=overlayP.getObject3D('mesh'); m.material.map=tex; m.material.needsUpdate=true; overlayP.__tex=tex; });

  const titleSlot=CFG.slotTitle, artistSlot=CFG.slotArtist, barSlot=CFG.slotBar;
  function fitFontFor(text, wpx, hpx, weight){
    let lo=12, hi=Math.floor(hpx*0.92), best=Math.floor(hpx*0.74);
    while(lo<=hi){ const mid=(lo+hi>>1); ctx.font=`${weight||700} ${mid}px system-ui,Segoe UI,Roboto`; if(ctx.measureText(text).width<=wpx*0.94){best=mid;lo=mid+1;}else hi=mid-1;}
    return best;
  }
  const titlePx=fitFontFor(CFG.title||'', titleSlot.w*Cw/PW, titleSlot.h*Ch/PH, 800);
  const artistPx=fitFontFor(CFG.artist||'',artistSlot.w*Cw/PW, artistSlot.h*Ch/PH, 600);

  /* ===== Audio + UI ===== */
  const btnAudio=document.getElementById('btnAudio');
  let audio=null, acx=null, analyser=null, lastBeat=0;
  function setupAudio(){
    if(audio) return;
    audio = new Audio(CFG.audio||''); audio.crossOrigin='anonymous'; audio.preload='auto';
    try{ const AC=window.AudioContext||window.webkitAudioContext; acx=new AC(); analyser=acx.createAnalyser(); analyser.fftSize=64; const src=acx.createMediaElementSource(audio); src.connect(analyser); analyser.connect(acx.destination);}catch{}
    audio.addEventListener('play',  ()=>btnAudio.textContent='‚è∏ Audio');
    audio.addEventListener('pause', ()=>btnAudio.textContent='‚ñ∂Ô∏è Audio');
  }
  btnAudio.onclick=async()=>{ setupAudio(); try{ if(audio.paused){ acx&&acx.state==='suspended'&&await acx.resume(); await audio.play(); } else { audio.pause(); } }catch{} };

  /* ===== Play t√°ctil en el p√≥ster ===== */
  if(CFG.slotPlay){
    const pb=px2(CFG.slotPlay.x,CFG.slotPlay.y,CFG.slotPlay.w,CFG.slotPlay.h);
    const hit = document.createElement('a-circle');
    hit.classList.add('ui3d');
    hit.setAttribute('radius', Math.min(pb.wn,pb.hn)/2.1);
    hit.setAttribute('position', `${pb.cx} ${pb.cy} 0.08`);
    hit.setAttribute('material','shader:flat; color:#000; opacity:0; transparent:true');
    hit.setAttribute('animation__tap','property:scale; from:0.95 0.95 1; to:1 1 1; dur:120; easing:easeOutQuad');
    root.appendChild(hit);
    hit.addEventListener('click', async()=>{ setupAudio(); try{ if(audio.paused){ acx&&acx.state==='suspended'&&await acx.resume(); await audio.play(); } else { audio.pause(); } hit.emit('animation__tap'); if(navigator.vibrate) navigator.vibrate(15);}catch{} });

    // aro con brillo (no tapa el v√≠deo)
    const ring=document.createElement('a-torus');
    ring.setAttribute('radius', Math.min(pb.wn,pb.hn)/2.2);
    ring.setAttribute('radius-tubular', 0.004);
    ring.setAttribute('rotation','90 0 0');
    ring.setAttribute('position', `${pb.cx} ${pb.cy} 0.075`);
    ring.setAttribute('material','shader:standard; color:#13d77a; emissive:#13d77a; emissiveIntensity:0.25; roughness:1; metalness:0; transparent:true; opacity:.9');
    ring.setAttribute('animation__breath','property:scale; from:0.98 0.98 0.98; to:1.02 1.02 1.02; dur:1200; easing:easeInOutSine; dir:alternate; loop:true');
    root.appendChild(ring);
    overlayP.__ring = ring;
  }

  /* ===== Barras 3D (mejoradas) ===== */
  const bars3D=[];
  (function makeBars3D(){
    const n=24;
    const pbx=barSlot.x, pby=barSlot.y, pbw=barSlot.w, pbh=barSlot.h;
    const boxWn=(pbw/PW)/n, cx=-0.5+(pbx+pbw/2)/PW, cy=H/2-(pby+pbh+ (24/PW)*Cw/2048)/PW;
    for(let i=0;i<n;i++){
      const b=document.createElement('a-box');
      b.setAttribute('width', boxWn*0.8);
      b.setAttribute('height', 0.002);
      b.setAttribute('depth', 0.01);
      b.setAttribute('position', `${cx - (pbw/PW)/2 + (i+0.5)*boxWn} ${cy} 0.05`);
      // degradado ‚Äúmanual‚Äù: alterna dos colores
      const col = (i%2)? (CFG.colors?.wave2 || '#ffd54a') : (CFG.colors?.wave1 || '#13d77a');
      b.setAttribute('material', `shader:standard; color:${col}; emissive:${col}; emissiveIntensity:0.20; roughness:1; metalness:0`);
      // idle breathing (aunque no haya m√∫sica)
      b.setAttribute('animation__idle', `property:scale; from:1 1 1; to:1 ${1+Math.random()*0.4} 1; dur:${900+Math.random()*600}; dir:alternate; loop:true; easing:easeInOutSine`);
      root.appendChild(b);
      bars3D.push(b);
    }
  })();

  /* ===== Overlay draw: textos + barra 2D ===== */
  function mmss(t){ if(!isFinite(t)||t<0) t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,'0')}`; }
  function draw(){
    ctx.clearRect(0,0,Cw,Ch);

    // t√≠tulo
    const tx=Math.round(titleSlot.x*Cw/PW), ty=Math.round(titleSlot.y*Ch/PH),
          tw=Math.round(titleSlot.w*Cw/PW), th=Math.round(titleSlot.h*Ch/PH);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`800 ${titlePx}px system-ui,Segoe UI,Roboto`;
    ctx.fillStyle='rgba(0,0,0,.28)'; ctx.fillText(CFG.title||'', tx+tw/2+2, ty+th/2+2);
    ctx.fillStyle=(CFG.colors?.title||'#000'); ctx.fillText(CFG.title||'', tx+tw/2, ty+th/2);

    // artista
    const ax=Math.round(artistSlot.x*Cw/PW), ay=Math.round(artistSlot.y*Ch/PH),
          aw=Math.round(artistSlot.w*Cw/PW), ah=Math.round(artistSlot.h*Ch/PH);
    ctx.font=`600 ${artistPx}px system-ui,Segoe UI,Roboto`;
    ctx.fillStyle='rgba(0,0,0,.18)'; ctx.fillText(CFG.artist||'', ax+aw/2+1.8, ay+ah/2+1.8);
    ctx.fillStyle=(CFG.colors?.artist||'#000'); ctx.fillText(CFG.artist||'', ax+aw/2, ay+ah/2);

    // barra
    const pbx=Math.round(barSlot.x*Cw/PW), pby=Math.round(barSlot.y*Ch/PH),
          pbw=Math.round(barSlot.w*Cw/PW), pbh=Math.max(2,Math.round(barSlot.h*Ch/PH));
    ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.fillRect(pbx, pby+2, pbw, pbh);
    ctx.fillStyle='#000'; ctx.fillRect(pbx, pby, pbw, pbh);

    let p=0, cur='0:00', dur='0:00';
    if(audio && audio.duration>0){ p=audio.currentTime/audio.duration; cur=mmss(audio.currentTime); dur=mmss(audio.duration); }
    const fw=Math.max(2, Math.floor(pbw*p));
    const grad=ctx.createLinearGradient(pbx,0,pbx+fw,0);
    grad.addColorStop(0, (CFG.colors?.wave1||'#13d77a'));
    grad.addColorStop(1, (CFG.colors?.wave2||'#ffd54a'));
    ctx.fillStyle=grad; ctx.fillRect(pbx, pby, fw, pbh);

    // knob + tiempos
    const kx=pbx+fw, ky=pby+pbh/2, r=Math.max(3, Math.round(pbh*0.9/2));
    ctx.beginPath(); ctx.arc(kx,ky,r,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
    ctx.fillStyle='#000'; ctx.textBaseline='alphabetic'; ctx.textAlign='left';
    ctx.font = `700 ${Math.round(28*Cw/2048)}px system-ui,Segoe UI,Roboto`;
    ctx.fillText(cur, pbx, pby - 10);
    ctx.textAlign='right'; ctx.fillText(dur, pbx+pbw, pby - 10);

    overlayP.__tex && (overlayP.__tex.needsUpdate = true);
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);

  /* ===== Tick de audio para barras 3D y aro ===== */
  function audioTick(){
    if(!analyser){ requestAnimationFrame(audioTick); return; }
    const data=new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(data);
    let level=0;
    for(let i=0;i<bars3D.length;i++){
      const v=(data[i+2]||0)/255; level+=v;
      const h=0.01+v*0.10;
      bars3D[i].setAttribute('scale', `1 ${h/0.002} 1`);
    }
    level/=bars3D.length;
    if(overlayP.__ring){ const ei = 0.15 + level*0.9; overlayP.__ring.setAttribute('material','emissiveIntensity', ei); }
    requestAnimationFrame(audioTick);
  }
  requestAnimationFrame(audioTick);

  /* ===== Ken Burns suave ===== */
  function kenBurns(){
    const B=vPlane.__base; if(!B){ requestAnimationFrame(kenBurns); return; }
    const dx=(Math.sin(performance.now()/6000)*0.015)*B.rx, dy=(Math.cos(performance.now()/9000)*0.015)*B.ry;
    const ox=Math.max(0, Math.min(1-B.rx, B.ox + dx));
    const oy=Math.max(0, Math.min(1-B.ry, B.oy + dy));
    B.tex.offset.set(ox, oy); B.tex.needsUpdate=true;
    requestAnimationFrame(kenBurns);
  }
  requestAnimationFrame(kenBurns);

  /* ===== Parallax opcional ===== */
  if(CFG.parallax){
    (function parallaxTick(){
      if(scene?.camera){
        const obj=root.object3D, cam3=scene.camera;
        const dx=cam3.position.x - obj.position.x, dy=cam3.position.y - obj.position.y, max=0.8;
        obj.rotation.x = THREE.MathUtils.degToRad(Math.max(-max, Math.min(max, dy*8)));
        obj.rotation.y = THREE.MathUtils.degToRad(Math.max(-max, Math.min(max, -dx*8)));
      }
      requestAnimationFrame(parallaxTick);
    })();
  }

  /* ===== Debug de slots ===== */
  if(qs.get('dbg')==='1'){
    function rectWire(slot,z,color){
      const b=document.createElement('a-plane');
      const u=px2(slot.x,slot.y,slot.w,slot.h);
      b.setAttribute('width',u.wn); b.setAttribute('height',u.hn); b.setAttribute('position',`${u.cx} ${u.cy} ${z}`);
      b.setAttribute('material',`shader:flat; color:${color}; transparent:true; opacity:.15; side:double`);
      root.appendChild(b);
    }
    rectWire(CFG.slotVid,   0.035, '#00e5ff');
    rectWire(CFG.slotTitle, 0.001, '#00ff88');
    rectWire(CFG.slotArtist,0.001, '#00ff88');
    rectWire(CFG.slotBar,   0.001, '#ffaa00');
    if(CFG.slotPlay) rectWire(CFG.slotPlay,0.085,'#ff4081');
    log('DBG: slots pintados');
  }

  /* ===== Estados / UI ===== */
  const btnStart=document.getElementById('btnStart');
  btnStart.onclick=async()=>{
    try{
      btnStart.disabled=true; log('Pidiendo c√°mara‚Ä¶');
      const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      s.getTracks().forEach(t=>t.stop());
      const sys=scene.systems['mindar-image-system']; const comp=scene.components['mindar-image'];
      if(sys && sys.start) await sys.start(); else if(comp && comp.start) await comp.start();
      btnStart.textContent='C√°mara lista';
    }catch(e){ btnStart.disabled=false; log('No se pudo iniciar c√°mara'); }
  };

  anchor.addEventListener('targetFound', ()=>{
    v1.play().catch(()=>{}); document.getElementById('btnAudio').disabled=false; log('Target FOUND');
    if(CFG.autoplay){ setupAudio(); audio.play().catch(()=>{}); }
  });
  anchor.addEventListener('targetLost',  ()=>{
    v1.pause(); audio?.pause(); btnAudio.textContent='‚ñ∂Ô∏è Audio'; log('Target LOST‚Ä¶');
  });

  // primer toque autom√°tico (mejor para iOS)
  window.addEventListener('pointerup', ()=>btnStart.click(), {once:true,passive:true});
})();
</script>
</body>
</html>

