<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR · Cinemático++</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* Cámara detrás */
  video[playsinline]{
    position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important
  }
  /* WebGL delante */
  a-scene,canvas.a-canvas{position:fixed!important;inset:0!important;z-index:3!important;pointer-events:none!important}

  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.3 system-ui;z-index:9}
  .cal{position:fixed;left:8px;bottom:8px;display:flex;gap:6px;flex-wrap:wrap;z-index:9}
  .chip{background:#0f1522;border:1px solid #2a3a58;color:#eaf2ff;border-radius:10px;padding:6px 8px}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button">📷 Abrir cámara</button>
  <button id="btnSound" class="btn" type="button" hidden>🔊 Activar sonido</button>
</div>
<div id="dbg" class="dbg">Cargando…</div>

<div class="cal" id="cal">
  <button data-a="dx-" class="btn">X−</button><button data-a="dx+" class="btn">X+</button>
  <button data-a="dy-" class="btn">Y−</button><button data-a="dy+" class="btn">Y+</button>
  <button data-a="sc-" class="btn">Scale−</button><button data-a="sc+" class="btn">Scale+</button>
  <button data-a="rt-" class="btn">Rot−</button><button data-a="rt+" class="btn">Rot+</button>
  <button id="copyUrl" class="btn">🔗 Copiar URL</button>
  <span id="readout" class="chip"></span>
</div>

<a-scene id="scene"
  embedded vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:true"
  renderer="alpha:true;antialias:true;logarithmicDepthBuffer:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;"
  style="width:100vw;height:100vh">

  <a-assets timeout="60000" id="assets">
    <!-- base del póster sin texto/foto -->
    <img id="base" crossorigin="anonymous"
         src="https://res.cloudinary.com/dtge9nklw/image/upload/v1759311815/poster_sin_foto_cancion_ztjqvw.png">
    <!-- vídeo del marco -->
    <video id="v1" playsinline webkit-playsinline muted autoplay loop preload="auto" crossorigin="anonymous"
           src="https://res.cloudinary.com/dtge9nklw/video/upload/f_mp4,vc_h264,ac_aac,br_1200k,vs_30,w_1280/v1759311664/0_Couple_Beach_3840x2160_fgnn6o.mp4"></video>
  </a-assets>

  <a-camera id="cam" look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(function(){
  const dbg = document.getElementById('dbg');
  const log = m => { dbg.textContent = m + ' · ' + new Date().toLocaleTimeString(); console.log('[AR]',m); };

  const qs = new URLSearchParams(location.search);

  // ===== Config =====
  const TARGET_URL = qs.get('t') || 'https://res.cloudinary.com/dtge9nklw/raw/upload/v1759341741/targets_10_h3yoq9.mind';
  const AUDIO_URL  = qs.get('audio') || 'https://res.cloudinary.com/dtge9nklw/video/upload/v1759311992/ssvid.app--Ed-Sheeran-Shape-of-You-Lyrics_vyw046.mp3';

  const titleTxt  = decodeURIComponent(qs.get('title') || 'Shape of You');
  const artistTxt = decodeURIComponent(qs.get('artist')|| 'Ed Sheeran');
  const titleCol  = '#'+(qs.get('tc1')||'000000');
  const artistCol = '#'+(qs.get('tc2')||'000000');

  // Tamaño del arte base
  const PW=2481, PH=3508, H=PH/PW;

  // Rectángulo del vídeo (en px del póster)
  const SLOT = {x:296, y:316, w:1890, h:1682};

  // Textos y elementos (en px del póster)
  const TITLE = {x:200, y:2150, w:2080, h:190};
  const ARTIST= {x:200, y:2330, w:2080, h:150};
  const PB    = {x:300, y:2640, w:2060, h:20};          // barra un pelín más alta
  const TIME_L= {x:300, y:2680, w:160, h:40};
  const TIME_R= {x:2060, y:2680, w:300, h:40};

  // Calibración
  const CAL = {
    dx: +(qs.get('dx')||-30),
    dy: +(qs.get('dy')||252),
    scale: +(qs.get('scale')||1.1),
    rot: +(qs.get('rot')||-0.6)
  };

  const PARALLAX = qs.get('parallax')==='1';

  // ===== A-Frame / MindAR =====
  const scene=document.getElementById('scene');
  scene.setAttribute('mindar-image', `imageTargetSrc:${TARGET_URL}; uiLoading: yes; autoStart:false; maxTrack:1; warmupTolerance:2; filterMinCF:0.0001; filterBeta:0.006;`);
  scene.addEventListener('loaded', ()=>{ try{ scene.renderer.setClearColor(0x000000,0);}catch{} });

  new MutationObserver(()=>{ document.querySelectorAll('video').forEach(v=>{
    if(v.srcObject instanceof MediaStream){ Object.assign(v.style,{objectFit:'cover',position:'fixed',inset:'0',width:'100vw',height:'100vh',zIndex:'0',background:'#000'}); }
  });}).observe(document.documentElement,{subtree:true,childList:true});

  const anchor=document.getElementById('anchor');
  const root=document.createElement('a-entity'); anchor.appendChild(root);
  root.setAttribute('animation__pop','property:scale; from:0.95 0.95 1; to:1 1 1; dur:380; easing:easeOutQuad; startEvents:pop');

  function applyCal(){
    root.setAttribute('position', `${CAL.dx/PW} ${-CAL.dy/PW} 0`);
    root.setAttribute('scale', `${CAL.scale} ${CAL.scale} 1`);
    root.setAttribute('rotation', `0 0 ${CAL.rot}`);
    document.getElementById('readout').textContent = `dx:${CAL.dx}px dy:${CAL.dy}px scale:${CAL.scale.toFixed(3)} rot:${CAL.rot}°`;
  }
  applyCal();

  const px2=(x,y,w,h)=>({wn:w/PW, hn:h/PW, cx:-0.5+(x+w/2)/PW, cy:H/2-(y+h/2)/PW});

  // ===== Fondo/Vignette + sombra elíptica =====
  const vignette=document.createElement('a-plane');
  vignette.setAttribute('width', 1.16);
  vignette.setAttribute('height', H*1.16);
  vignette.setAttribute('position','0 0 -0.03');
  vignette.setAttribute('material','shader:flat; color:#000; opacity:.22; transparent:true; side:double; depthTest:false');
  root.appendChild(vignette);

  const shadow=document.createElement('a-plane');
  shadow.setAttribute('width', 0.86);
  shadow.setAttribute('height', H*0.05);
  shadow.setAttribute('position', `0 ${-H*0.48} -0.029`);
  shadow.setAttribute('rotation','-8 0 0');
  shadow.setAttribute('material','shader:flat; color:#000; opacity:.18; transparent:true; side:double; depthTest:false');
  root.appendChild(shadow);

  // ===== Canvas overlay (diseño, textos y FX 2D) =====
  const baseImg = document.getElementById('base');
  const Cw = 2048, Ch = Math.round(Cw*H);
  const canvas = document.createElement('canvas'); canvas.width=Cw; canvas.height=Ch;
  const ctx = canvas.getContext('2d');

  const overlayP = document.createElement('a-plane');
  overlayP.setAttribute('width',1); overlayP.setAttribute('height',H);
  overlayP.setAttribute('position','0 0 0.0');
  overlayP.setAttribute('material','shader:flat; transparent:true; side:double; depthTest:false; opacity:0');
  overlayP.setAttribute('animation__fade','property:material.opacity; from:0; to:1; dur:380; easing:easeOutQuad; startEvents:show');
  root.appendChild(overlayP);

  overlayP.addEventListener('loaded', ()=>{
    const tex = new AFRAME.THREE.CanvasTexture(canvas);
    tex.needsUpdate = true;
    const mesh = overlayP.getObject3D('mesh');
    mesh.material.map = tex; mesh.material.needsUpdate = true;
    overlayP.__tex = tex;
  });

  // ===== Vídeo limpio + micro Ken-Burns (sobre cover base) =====
  const v1=document.getElementById('v1');
  const u = px2(SLOT.x,SLOT.y,SLOT.w,SLOT.h);
  const vPlane=document.createElement('a-plane');
  vPlane.setAttribute('width',u.wn); vPlane.setAttribute('height',u.hn);
  vPlane.setAttribute('position',`${u.cx} ${u.cy} 0.03`);
  vPlane.setAttribute('material','shader:flat; src:#v1; side:double; depthTest:false; opacity:1');
  root.appendChild(vPlane);

  function setCoverAndBase(){
    const mesh=vPlane.getObject3D('mesh'); if(!mesh||!mesh.material||!mesh.material.map||!v1.videoWidth) return;
    const tex=mesh.material.map, vr=v1.videoWidth/v1.videoHeight, rr=SLOT.w/SLOT.h;
    let rx=1,ry=1,ox=0,oy=0;
    if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
    tex.offset.set(ox,oy); tex.repeat.set(rx,ry); tex.needsUpdate=true; mesh.material.needsUpdate=true;
    vPlane.__base = {ox,oy,rx,ry,tex};
  }
  vPlane.addEventListener('materialtextureloaded', setCoverAndBase);
  v1.addEventListener('loadedmetadata', ()=>{ v1.play().catch(()=>{}); setCoverAndBase(); }, {once:true});

  // ===== Audio + WebAudio analyser =====
  let audio=null, userOK=false, acx=null, analyser=null, dataArr=null;
  let lastBeat=0;

  function mmss(t){ if(!isFinite(t)||t<0) t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${s.toString().padStart(2,'0')}`; }

  // ===== Partículas (corazones/estrellas) =====
  function burstParticles(color='#13d77a', count=10){
    for(let i=0;i<count;i++){
      const p=document.createElement('a-circle');
      p.setAttribute('radius', 0.006 + Math.random()*0.01);
      p.setAttribute('material',`shader:flat; color:${color}; transparent:true; opacity:0.95; side:double; depthTest:false`);
      p.setAttribute('position', `${(Math.random()-0.5)*0.3} ${-H*0.20 + Math.random()*0.08} 0.13`);
      const dy = 0.18 + Math.random()*0.22;
      const dx = (Math.random()-0.5)*0.25;
      const dur = 900 + Math.random()*600;
      p.setAttribute('animation__move', `property:position; to:${dx} ${-H*0.20+dy} 0.13; dur:${dur}; easing:easeOutQuad`);
      p.setAttribute('animation__fade', `property:material.opacity; from:0.95; to:0; dur:${dur}; easing:linear`);
      p.setAttribute('animation__scale', `property:scale; from:0.8 0.8 1; to:1.4 1.4 1; dur:${dur}`);
      root.appendChild(p);
      setTimeout(()=>p.remove(), dur+80);
    }
  }

  // ===== Dibujo del overlay (textos, barra, waveform, sweep) =====
  let t0=performance.now(), sweepT=0;
  const bars=32;

  function fitFontFor(text, wpx, hpx, weight){
    let lo=12, hi=Math.floor(hpx*0.92), best=Math.floor(hpx*0.75);
    while(lo<=hi){
      const mid=(lo+hi>>1);
      ctx.font = `${weight||700} ${mid}px system-ui,Segoe UI,Roboto`;
      if(ctx.measureText(text).width <= wpx*0.94){ best=mid; lo=mid+1; } else hi=mid-1;
    }
    return best;
  }
  const titlePx = fitFontFor(titleTxt, TITLE.w*Cw/PW, TITLE.h*Ch/PH, 800);
  const artistPx= fitFontFor(artistTxt, ARTIST.w*Cw/PW, ARTIST.h*Ch/PH, 600);

  function drawOverlay(){
    const now = performance.now(); const dt = (now - t0)/1000; t0 = now; sweepT += dt;

    // base
    if(baseImg.complete) ctx.drawImage(baseImg, 0, 0, Cw, Ch);
    else { ctx.fillStyle='#fff'; ctx.fillRect(0,0,Cw,Ch); }

    // título con shimmer
    const tx = Math.round(TITLE.x*Cw/PW), ty=Math.round(TITLE.y*Ch/PH),
          tw = Math.round(TITLE.w*Cw/PW), th=Math.round(TITLE.h*Ch/PH);
    const off = (now*0.06)%tw;
    const grad = ctx.createLinearGradient(tx,ty, tx+tw,ty);
    grad.addColorStop(Math.max(0,(off-140)/tw),'rgba(255,255,255,0)');
    grad.addColorStop(Math.max(0,(off-70)/tw), 'rgba(255,255,255,.65)');
    grad.addColorStop(Math.min(1,(off)/tw),     'rgba(255,255,255,0)');

    ctx.fillStyle=titleCol; ctx.textBaseline='middle'; ctx.textAlign='center';
    ctx.shadowColor='rgba(0,0,0,0.26)'; ctx.shadowBlur=Math.floor(th*.06); ctx.shadowOffsetY=Math.floor(th*.03);
    ctx.font=`800 ${titlePx}px system-ui,Segoe UI,Roboto`;
    ctx.fillText(titleTxt, tx+tw/2, ty+th/2);
    ctx.save(); ctx.globalCompositeOperation='lighter'; ctx.fillStyle=grad; ctx.fillRect(tx, ty, tw, th); ctx.restore();

    // artista
    const ax = Math.round(ARTIST.x*Cw/PW), ay=Math.round(ARTIST.y*Ch/PH),
          aw = Math.round(ARTIST.w*Cw/PW), ah=Math.round(ARTIST.h*Ch/PH);
    ctx.shadowColor='rgba(0,0,0,0.18)'; ctx.shadowBlur=Math.floor(ah*.05); ctx.shadowOffsetY=Math.floor(ah*.02);
    ctx.fillStyle=artistCol; ctx.font=`600 ${artistPx}px system-ui,Segoe UI,Roboto`;
    ctx.fillText(artistTxt, ax+aw/2, ay+ah/2);

    // barra y tiempos
    const pbx=Math.round(PB.x*Cw/PW), pby=Math.round(PB.y*Ch/PH),
          pbw=Math.round(PB.w*Cw/PW), pbh=Math.max(2,Math.round(PB.h*Ch/PH));

    // glow leve debajo
    ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.fillRect(pbx, pby+2, pbw, pbh);
    ctx.fillStyle='#000'; ctx.fillRect(pbx, pby, pbw, pbh);

    let p=0, cur='0:00', dur='0:00';
    if(audio && audio.duration>0){ p = audio.currentTime/audio.duration; cur=mmss(audio.currentTime); dur=mmss(audio.duration); }
    const fw = Math.max(2, Math.floor(pbw*p));
    ctx.fillStyle='#13d77a'; ctx.fillRect(pbx, pby, fw, pbh);

    // knob con pulso
    const kx = pbx + fw; const ky = pby + pbh/2;
    const baseR = Math.max(3, Math.round(pbh*0.9/2));
    const pulse = 1 + 0.10*Math.sin(now/220);
    ctx.beginPath(); ctx.arc(kx,ky,baseR*pulse,0,Math.PI*2); ctx.fillStyle='#000'; ctx.fill();

    // tiempos
    ctx.shadowColor='transparent';
    ctx.fillStyle='#000'; ctx.textBaseline='alphabetic'; ctx.textAlign='left';
    ctx.font = `700 ${Math.round(28*Cw/2048)}px system-ui,Segoe UI,Roboto`;
    ctx.fillText(cur, Math.round(TIME_L.x*Cw/PW), Math.round((TIME_L.y+TIME_L.h)*Ch/PH));
    ctx.textAlign='right';
    ctx.fillText(dur, Math.round((TIME_R.x+TIME_R.w)*Cw/PW), Math.round((TIME_R.y+TIME_R.h)*Ch/PH));

    // waveform
    const bx=pbx, by=pby - Math.round(22*Cw/2048), bw=pbw, bh=Math.round(18*Cw/2048);
    ctx.save(); ctx.translate(bx,by+bh);
    const step=bw/bars;
    let level=0;
    for(let i=0;i<bars;i++){
      let v = 0.2 + 0.8*Math.abs(Math.sin((now/260)+(i*0.37)));
      if(analyser){ analyser.getByteFrequencyData(dataArr); v = (dataArr[2+i]||0)/255; level += v; }
      const h = Math.max(2, Math.round(v*bh));
      const x = Math.round(i*step + step*0.2);
      ctx.fillStyle='#13d77a';
      ctx.fillRect(x, -h, Math.max(2,Math.round(step*0.6)), h);
    }
    ctx.restore();

    // beat → partículas
    if(analyser){
      level/=bars;
      const nowMs=performance.now();
      if(level>0.48 && nowMs-lastBeat>200){ lastBeat=nowMs; burstParticles('#13d77a', 6); }
    }

    // light-sweep del marco
    const pad = Math.round(14*Cw/2048);
    const lw = Math.round(3*Cw/2048);
    ctx.lineWidth = lw;
    ctx.strokeStyle='rgba(255,255,255,0.75)';
    const per = (sweepT%4)/4;
    const rx=pad, ry=pad, rw=Cw-pad*2, rh=Ch-pad*2;
    ctx.save(); ctx.beginPath();
    const L = rw*2+rh*2, Lp=L*per;
    function drawPartial(len){
      let d=len; ctx.moveTo(rx,ry);
      if(d<=rw){ ctx.lineTo(rx+d, ry); return; } else { ctx.lineTo(rx+rw, ry); d-=rw; }
      if(d<=rh){ ctx.lineTo(rx+rw, ry+d); return; } else { ctx.lineTo(rx+rw, ry+rh); d-=rh; }
      if(d<=rw){ ctx.lineTo(rx+rw-d, ry+rh); return; } else { ctx.lineTo(rx, ry+rh); d-=rw; }
      ctx.lineTo(rx, ry+rh-d);
    }
    drawPartial(Lp); ctx.stroke(); ctx.restore();

    // micro “glare” diagonal en la foto (muy sutil)
    const vx=Math.round(SLOT.x*Cw/PW), vy=Math.round(SLOT.y*Ch/PH),
          vw=Math.round(SLOT.w*Cw/PW), vh=Math.round(SLOT.h*Ch/PH);
    const g=ctx.createLinearGradient(vx,vy, vx+vw, vy+vh);
    const t = (performance.now()%3000)/3000;
    g.addColorStop(Math.max(0,t-0.08),'rgba(255,255,255,0)');
    g.addColorStop(Math.min(1,t),'rgba(255,255,255,0.08)');
    g.addColorStop(Math.min(1,t+0.08),'rgba(255,255,255,0)');
    ctx.fillStyle=g; ctx.fillRect(vx,vy,vw,vh);

    // actualizar textura
    if(overlayP.__tex){ overlayP.__tex.needsUpdate = true; }
  }

  // Ken-Burns suave: desplaza ligeramente dentro del recorte
  function kenBurns(){
    const B=vPlane.__base; if(!B) return;
    const dx = (Math.sin(performance.now()/6000)*0.015)*B.rx;
    const dy = (Math.cos(performance.now()/9000)*0.015)*B.ry;
    const ox = Math.max(0, Math.min(1-B.rx, B.ox + dx));
    const oy = Math.max(0, Math.min(1-B.ry, B.oy + dy));
    B.tex.offset.set(ox, oy); B.tex.needsUpdate=true;
  }

  function loop(){ drawOverlay(); kenBurns(); requestAnimationFrame(loop); }
  requestAnimationFrame(loop);

  // ===== Parallax =====
  function parallaxTick(){
    if(!PARALLAX || !scene?.camera) return requestAnimationFrame(parallaxTick);
    const obj=root.object3D, cam3=scene.camera;
    const dx=cam3.position.x - obj.position.x;
    const dy=cam3.position.y - obj.position.y;
    const max=0.8;
    obj.rotation.x = THREE.MathUtils.degToRad(Math.max(-max, Math.min(max, dy*8)));
    obj.rotation.y = THREE.MathUtils.degToRad(Math.max(-max, Math.min(max, -dx*8)));
    requestAnimationFrame(parallaxTick);
  }
  requestAnimationFrame(parallaxTick);

  // ===== Estados AR =====
  anchor.addEventListener('targetFound', ()=>{
    overlayP.emit('show',null,false);
    root.emit('pop',null,false);
    v1.play().catch(()=>{});
    if(userOK){ audio?.play().catch(()=>{}); document.getElementById('btnSound').hidden=true; }
    else document.getElementById('btnSound').hidden=false;
    log('Target FOUND');
  });
  anchor.addEventListener('targetLost', ()=>{
    v1.pause(); audio?.pause();
    if(audio && userOK) document.getElementById('btnSound').hidden=false;
    log('Target LOST…');
  });

  // ===== Interacciones / UI =====
  const btnStart=document.getElementById('btnStart');
  btnStart.onclick=async()=>{
    try{
      const sys=scene.systems['mindar-image-system']; const comp=scene.components['mindar-image'];
      if(sys && sys.start) await sys.start(); else if(comp && comp.start) await comp.start();
      btnStart.disabled=true; btnStart.textContent='Cámara lista'; log('Cámara iniciada');
    }catch{ log('No se pudo iniciar cámara'); }
  };

  const btnSound=document.getElementById('btnSound');
  btnSound.onclick=async()=>{
    try{
      if(!audio){
        audio = new Audio(AUDIO_URL); audio.crossOrigin='anonymous'; audio.preload='auto';
        try{
          acx = new (window.AudioContext||window.webkitAudioContext)();
          analyser = acx.createAnalyser(); analyser.fftSize = 64;
          dataArr = new Uint8Array(analyser.frequencyBinCount);
          const srcNode = acx.createMediaElementSource(audio);
          srcNode.connect(analyser); analyser.connect(acx.destination);
        }catch(e){ /* fallback breathing */ }
      }
      userOK=true; await audio.play(); v1.play().catch(()=>{});
      if(acx && acx.state==='suspended') await acx.resume();
      btnSound.hidden=true;
      burstParticles('#ffd54a', 10); // arranque con partículas doradas
    }catch(e){}
  };

  // Tap sobre el póster: play/pause + vibración + partículas
  root.addEventListener('click', ()=>{
    const any = audio && !audio.paused;
    if(any){ audio.pause(); v1.pause(); burstParticles('#ff6d6d', 8); }
    else { audio?.play().catch(()=>{}); v1.play().catch(()=>{}); burstParticles('#13d77a', 8); }
    if(navigator.vibrate) navigator.vibrate(20);
  });

  // calibración
  if(qs.get('cal')==='0') document.getElementById('cal').style.display='none';
  document.querySelectorAll('#cal [data-a]').forEach(b=>{
    b.onclick=()=>{
      const s=6, sc=0.005, rt=0.2, a=b.dataset.a;
      if(a==='dx-') CAL.dx-=s; if(a==='dx+') CAL.dx+=s;
      if(a==='dy-') CAL.dy-=s; if(a==='dy+') CAL.dy+=s;
      if(a==='sc-') CAL.scale=Math.max(0.9,CAL.scale-sc);
      if(a==='sc+') CAL.scale=Math.min(1.2,CAL.scale+sc);
      if(a==='rt-') CAL.rot-=rt; if(a==='rt+') CAL.rot+=rt;
      applyCal();
    };
  });
  document.getElementById('copyUrl').onclick=async()=>{
    const url=new URL(location.href);
    url.searchParams.set('dx', Math.round(CAL.dx));
    url.searchParams.set('dy', Math.round(CAL.dy));
    url.searchParams.set('scale', +CAL.scale.toFixed(4));
    url.searchParams.set('rot', +CAL.rot.toFixed(2));
    try{ await navigator.clipboard.writeText(url.toString()); alert('URL copiada'); }catch{ prompt('Copia la URL', url.toString()); }
  };

  scene.addEventListener('arReady', ()=>log('Cámara OK'));
  scene.addEventListener('arError', ()=>log('Error cámara/permisos'));

  // auto-start con primer gesto
  window.addEventListener('pointerup', ()=>btnStart.click(), {once:true,passive:true});
})();
</script>
</body>
</html>
