<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MindAR ¬∑ Test de detecci√≥n</title>

<!-- A-Frame + MindAR -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000}
  /* El v√≠deo de la c√°mara debe ocupar toda la pantalla y quedar detr√°s */
  video[playsinline]{
    position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important
  }
  /* El lienzo WebGL encima (para ver los planos verdes) */
  a-scene{position:fixed!important;inset:0!important;z-index:2!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:3!important}

  .ui{position:fixed;left:10px;top:10px;z-index:9;display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #345;background:#0f1522;color:#eaf2ff}
  .log{position:fixed;right:10px;top:10px;z-index:9;color:#cfe3ff;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;padding:8px 10px;max-width:46ch}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn">üì∑ Abrir c√°mara</button>
</div>
<div id="log" class="log">Listo‚Ä¶</div>

<a-scene id="scene" embedded vr-mode-ui="enabled:false" loading-screen="enabled:false"
  mindar-image="autoStart:false; uiLoading: yes; maxTrack:1;"
  renderer="alpha:true;antialias:true">
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchors"></a-entity>
</a-scene>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const t = qs.get('t') || '';
  const n = Math.max(1, +(qs.get('n')||8));
  const logEl = document.getElementById('log');
  const btnStart = document.getElementById('btnStart');
  const scene = document.getElementById('scene');
  const anchorsHolder = document.getElementById('anchors');

  function say(m){ logEl.textContent = m; console.log('[TEST]', m); }

  if(!t){
    say('‚ùó Falta par√°metro ?t=URL_DEL_MIND');
    return;
  }

  // Asegura que el v√≠deo de la c√°mara (creado por MindAR) tenga estilo cover
  new MutationObserver(()=>{
    document.querySelectorAll('video').forEach(v=>{
      if(v.srcObject instanceof MediaStream){
        Object.assign(v.style,{
          objectFit:'cover', position:'fixed', inset:'0',
          width:'100vw', height:'100vh', zIndex:'0', background:'#000'
        });
      }
    });
  }).observe(document.documentElement,{subtree:true,childList:true});

  // Crea anchors 0..n-1 con un plano verde visible al detectar
  for(let i=0;i<n;i++){
    const a=document.createElement('a-entity');
    a.setAttribute('mindar-image-target', `targetIndex:${i}`);
    const p=document.createElement('a-plane');
    p.setAttribute('width',0.6);
    p.setAttribute('height',0.4);
    p.setAttribute('material','color:#00ff88; opacity:.45; side:double');
    a.appendChild(p);
    anchorsHolder.appendChild(a);
    a.addEventListener('targetFound', ()=>say('‚úÖ FOUND idx '+i));
    a.addEventListener('targetLost',  ()=>say('‚Ä¶lost idx '+i));
  }

  // Configura la escena con el target indicado
  scene.setAttribute('mindar-image', `autoStart:false; imageTargetSrc:${t}; uiLoading: yes; maxTrack:1;`);

  // Eventos √∫tiles
  scene.addEventListener('arReady', ()=>say('AR listo (permisos OK)'));
  scene.addEventListener('arError', (e)=>say('‚ùó Error AR/c√°mara: '+(e?.detail||'')));

  async function ensurePermission(){
    // Pedir permiso expl√≠cito (iOS/Android) antes de iniciar MindAR, y soltarlo
    try{
      const s = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:{ideal:'environment'}}, audio:false
      });
      s.getTracks().forEach(t=>t.stop());
      return true;
    }catch(err){
      say('‚ùó No se pudo obtener permiso de c√°mara: '+(err?.name||err));
      return false;
    }
  }

  async function startMindAR(){
    const sys = scene.systems && scene.systems['mindar-image-system'];
    const comp= scene.components && scene.components['mindar-image'];
    if(sys && sys.start) return sys.start();
    if(comp && comp.start) return comp.start();
    throw new Error('MindAR no disponible');
  }

  async function start(){
    btnStart.disabled = true;
    say('Comprobando .mind‚Ä¶');
    // Verifica que el .mind se descarga (CORS + 200)
    try{
      const r = await fetch(t, {mode:'cors', cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      say('OK .mind ('+r.status+')');
    }catch(e){
      say('‚ùó No pude descargar el .mind: '+(e.message||e));
      btnStart.disabled = false;
      return;
    }

    // Intento directo de iniciar MindAR
    try{
      say('Iniciando AR‚Ä¶');
      await startMindAR();
      say('C√°mara lista. Apunta al p√≥ster.');
      return;
    }catch(e1){
      say('Solicitando permisos de c√°mara‚Ä¶');
      const ok = await ensurePermission();
      if(!ok){ btnStart.disabled=false; return; }
      try{
        say('Iniciando AR tras permisos‚Ä¶');
        await startMindAR();
        say('C√°mara lista. Apunta al p√≥ster.');
        return;
      }catch(e2){
        say('‚ùó No se pudo iniciar MindAR: '+(e2?.name||e2));
        btnStart.disabled=false;
      }
    }
  }

  btnStart.addEventListener('click', start, {passive:true});
  // Primer toque auto (mejora UX)
  window.addEventListener('pointerup', ()=>btnStart.click(), {once:true, passive:true});
})();
</script>
</body>
</html>
