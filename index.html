<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MindAR ¬∑ Test de detecci√≥n</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  video[playsinline]{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:0}
  a-scene{position:fixed;inset:0;z-index:2}
  .ui{position:fixed;left:10px;top:10px;z-index:9;display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #345;background:#0f1522;color:#eaf2ff}
  .log{position:fixed;right:10px;top:10px;z-index:9;color:#cfe3ff;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;padding:8px 10px;max-width:42ch}
</style>
</head>
<body>
<div class="ui">
  <button id="start" class="btn">üì∑ Abrir c√°mara</button>
</div>
<div id="log" class="log">Listo‚Ä¶</div>

<a-scene id="scene" embedded vr-mode-ui="enabled:false" loading-screen="enabled:false"
  mindar-image="autoStart:false; uiLoading: yes; maxTrack:1;"
  renderer="alpha:true;antialias:true">
  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchors"></a-entity>
</a-scene>

<script>
(async()=>{
  const qs=new URLSearchParams(location.search);
  const t = qs.get('t') || 'https://res.cloudinary.com/dtge9nklw/raw/upload/v1759401459/targets_12_j14r8e.mind';
  const n = Math.max(1, +(qs.get('n')||8));
  const logEl = document.getElementById('log');
  const say = m => { logEl.textContent = m; console.log('[TEST]', m); };

  // 1) Comprobar que el .mind responde (CORS/200)
  try{
    const r = await fetch(t, {mode:'cors', cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    say('OK .mind ('+r.status+')');
  }catch(e){
    say('‚ùó No pude descargar el .mind: '+e.message);
    return;
  }

  // 2) Configurar MindAR con ese target
  const scene = document.getElementById('scene');
  scene.setAttribute('mindar-image', `autoStart:false; imageTargetSrc:${t}; uiLoading: yes; maxTrack:1;`);

  // 3) Crear anchors 0..n-1
  const holder = document.getElementById('anchors');
  for(let i=0;i<n;i++){
    const a=document.createElement('a-entity');
    a.setAttribute('mindar-image-target', `targetIndex:${i}`);
    // un rect√°ngulo verde para ver detecci√≥n
    const p=document.createElement('a-plane');
    p.setAttribute('width',0.6); p.setAttribute('height',0.4);
    p.setAttribute('material','color:#00ff88; opacity:.45; side:double');
    a.appendChild(p);
    holder.appendChild(a);
    a.addEventListener('targetFound', ()=>say('‚úÖ FOUND idx '+i));
    a.addEventListener('targetLost',  ()=>say('‚Ä¶lost idx '+i));
  }

  // 4) Arranque robusto
  async function start(){
    try{
      document.getElementById('start').disabled = true;
      say('Pidiendo c√°mara‚Ä¶');
      // pedir permisos primero (mejor UX)
      const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}, audio:false});
      s.getTracks().forEach(t=>t.stop());
      say('Permisos OK. Iniciando MindAR‚Ä¶');
      const sys = scene.systems['mindar-image-system'];
      const comp= scene.components['mindar-image'];
      if(sys && sys.start) await sys.start(); else if(comp && comp.start) await comp.start();
      say('Cam lista. Apunta al p√≥ster.');
    }catch(e){
      say('‚ùó No se pudo abrir c√°mara: '+(e.message||e));
      document.getElementById('start').disabled = false;
    }
  }
  document.getElementById('start').onclick = start;
  // primer toque auto
  window.addEventListener('pointerup', ()=>document.getElementById('start').click(), {once:true,passive:true});
})();
</script>
</body>
</html>
