<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Poster AR · Universal (LITE)</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000}
  /* Solo el feed de cámara de MindAR como fondo */
  #mindar-image-video, #mindar-video{
    position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;
    object-fit:cover!important;z-index:0!important;background:#000!important
  }
  a-scene{position:fixed!important;inset:0!important;z-index:3!important}
  canvas.a-canvas{position:fixed!important;inset:0!important;z-index:4!important}
  .ui{position:fixed;left:8px;top:8px;display:flex;gap:8px;z-index:9}
  .btn{border:1px solid #2a3a58;background:#0f1522;color:#eaf2ff;border-radius:10px;padding:8px 10px}
  .dbg{position:fixed;right:8px;top:8px;background:#0f1522cc;border:1px solid #22324d;border-radius:8px;
       padding:8px 10px;color:#cfe3ff;font:12px/1.35 system-ui;z-index:8;pointer-events:none;opacity:.2;transition:opacity .35s;white-space:pre}
  .dbg:hover{opacity:1}
</style>
</head>
<body>
<div class="ui">
  <button id="btnStart" class="btn" type="button" disabled>⏳ Preparando…</button>
  <button id="btnAudio" class="btn" type="button" disabled>▶️ Audio</button>
</div>
<div id="dbg" class="dbg">Cargando…</div>

<a-scene id="scene"
  embedded
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  renderer="alpha:true;antialias:true"
  loading-screen="enabled:false"
  mindar-image="uiLoading: true; autoStart:false; maxTrack:1"
  style="width:100vw;height:100vh">

  <a-assets timeout="60000">
    <!-- Vídeo de CONTENIDO (no la cámara). Se asigna por JS -->
    <video id="v1" playsinline webkit-playsinline muted autoplay loop preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <a-camera id="cam" look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(function(){
  'use strict';

  /* ---------- utils ---------- */
  var qs = new URLSearchParams(location.search);
  function log(){
    var msg=[].slice.call(arguments).join(' ');
    var el=document.getElementById('dbg');
    el.textContent=msg+'\n'+new Date().toLocaleTimeString();
    el.style.opacity=.9; setTimeout(function(){el.style.opacity=.2;},1200);
    console.log('[AR]', msg);
  }
  function mindarVideoEl(){ return document.getElementById('mindar-image-video') || document.getElementById('mindar-video'); }
  function setRO(el, order, depthTest, depthWrite){
    el.addEventListener('loaded', function(){
      var mesh = el.getObject3D('mesh'); if(!mesh) return;
      mesh.renderOrder = order;
      if(mesh.material){ mesh.material.depthTest=!!depthTest; mesh.material.depthWrite=!!depthWrite; mesh.material.needsUpdate=true; }
    });
  }

  /* ---------- cargar cfg ---------- */
  var cfgUrl = qs.get('cfg');
  if(!cfgUrl){ log('Falta ?cfg=URL_DEL_JSON'); return; }
  fetch(cfgUrl, {mode:'cors', cache:'no-store'})
    .then(function(r){ return r.json(); })
    .then(function(CFG){ init(CFG); })
    .catch(function(e){ log('❗ No pude cargar el JSON', e && e.message || e); });

  function init(CFG){
    var scene = document.getElementById('scene');

    /* Re-configura MindAR con tu target */
    scene.setAttribute('mindar-image', 'imageTargetSrc:'+CFG.target+'; uiLoading:true; autoStart:false; maxTrack:1');

    /* layout base del póster */
    var PW=CFG.pw||2481, PH=CFG.ph||3508, H=PH/PW;
    function px2(x,y,w,h){ return {wn:w/PW, hn:h/PW, cx:-0.5+(x+w/2)/PW, cy:H/2-(y+h/2)/PW}; }

    var anchor=document.getElementById('anchor');
    var root=document.createElement('a-entity'); anchor.appendChild(root);

    var cal=(CFG.cal||{dx:0,dy:0,scale:1,rot:0});
    root.setAttribute('position', (cal.dx/PW)+' '+(-cal.dy/PW)+' 0');
    root.setAttribute('scale', cal.scale+' '+cal.scale+' 1');
    root.setAttribute('rotation', '0 0 '+cal.rot);

    /* papel */
    var paper=document.createElement('a-plane');
    paper.setAttribute('width',1); paper.setAttribute('height',H);
    paper.setAttribute('position','0 0 -0.01');
    paper.setAttribute('material','shader:flat; color:#ffffff; side:double; transparent:false');
    root.appendChild(paper); setRO(paper, 1, false, false);

    /* slot de vídeo */
    var vslot=CFG.slotVid, u=px2(vslot.x,vslot.y,vslot.w,vslot.h);
    var glow1=(CFG.colors&&CFG.colors.wave1)||'#13d77a';
    var glow2=(CFG.colors&&CFG.colors.wave2)||'#ffd54a';

    /* marco simple (sin runners ni strips) */
    var frame=document.createElement('a-plane');
    frame.setAttribute('width',u.wn*1.018); frame.setAttribute('height',u.hn*1.018);
    frame.setAttribute('position',u.cx+' '+u.cy+' 0.000');
    frame.setAttribute('material','shader:flat; color:#e9eef2; side:double');
    root.appendChild(frame); setRO(frame, 5, false, false);

    /* vídeo de CONTENIDO */
    var v1=document.getElementById('v1');
    v1.crossOrigin='anonymous';
    v1.muted=true;           // iOS autoplay-safe
    v1.playsInline=true;     // iOS inline
    v1.setAttribute('playsinline','true');
    v1.setAttribute('webkit-playsinline','true');
    v1.src = CFG.video || '';
    v1.load();

    var vPlane=document.createElement('a-plane');
    vPlane.setAttribute('width',u.wn);
    vPlane.setAttribute('height',u.hn);
    vPlane.setAttribute('position',u.cx+' '+u.cy+' 0.02');
    vPlane.setAttribute('material','shader:flat; side:double; transparent:false; src:#v1');
    root.appendChild(vPlane); setRO(vPlane, 100, true, true);

    function coverFromMap(map){
      if(!map || !v1.videoWidth) return;
      var vr=v1.videoWidth/v1.videoHeight, rr=vslot.w/vslot.h;
      var rx=1,ry=1,ox=0,oy=0;
      if(vr>rr){ rx=rr/vr; ry=1; ox=(1-rx)/2; } else { rx=1; ry=vr/rr; oy=(1-ry)/2; }
      map.offset.set(ox,oy); map.repeat.set(rx,ry); map.needsUpdate=true;
    }
    vPlane.addEventListener('materialtextureloaded', function(e){ coverFromMap(e.detail.texture); });
    v1.addEventListener('loadedmetadata', function(){
      var mesh=vPlane.getObject3D('mesh');
      if(mesh && mesh.material && mesh.material.map) coverFromMap(mesh.material.map);
    });

    /* Overlay canvas muy básico: Título + Artista + barra (sin animación de picos) */
    var Cw=2048, Ch=Math.round(Cw*H);
    var canvas=document.createElement('canvas'); canvas.width=Cw; canvas.height=Ch;
    var ctx=canvas.getContext('2d');

    var overlay=document.createElement('a-plane');
    overlay.setAttribute('width',1); overlay.setAttribute('height',H);
    overlay.setAttribute('position','0 0 0.0');
    overlay.setAttribute('material','shader:flat; transparent:true; side:double; opacity:1');
    root.appendChild(overlay); setRO(overlay, 3, false, false);
    overlay.addEventListener('loaded', function(){
      var tex=new AFRAME.THREE.CanvasTexture(canvas); tex.needsUpdate=true;
      var m=overlay.getObject3D('mesh'); if(m&&m.material){ m.material.map=tex; m.material.needsUpdate=true; }
      overlay.__tex=tex;
    });

    var titleSlot=CFG.slotTitle, artistSlot=CFG.slotArtist, barSlot=CFG.slotBar;
    function fitFontFor(text,wpx,hpx,weight){
      var lo=12,hi=Math.floor(hpx*0.92),best=Math.floor(hpx*0.74);
      while(lo<=hi){
        var mid=(lo+hi>>1);
        ctx.font=(weight||700)+' '+mid+'px system-ui,Segoe UI,Roboto';
        if(ctx.measureText(text).width<=wpx*0.94){ best=mid; lo=mid+1; } else { hi=mid-1; }
      }
      return best;
    }
    var titlePx=fitFontFor(CFG.title||'', titleSlot.w*Cw/PW, titleSlot.h*Ch/PH, 800);
    var artistPx=fitFontFor(CFG.artist||'',artistSlot.w*Cw/PW, artistSlot.h*Ch/PH, 600);

    var btnAudio=document.getElementById('btnAudio');
    var audio=null;
    function setupAudio(){
      if(audio) return;
      audio=new Audio(CFG.audio||''); audio.crossOrigin='anonymous'; audio.preload='auto';
      audio.addEventListener('play', function(){ btnAudio.textContent='⏸ Audio'; });
      audio.addEventListener('pause',function(){ btnAudio.textContent='▶️ Audio'; });
    }
    btnAudio.addEventListener('click', function(){
      setupAudio();
      try{ if(audio.paused){ audio.play().catch(function(){}); } else { audio.pause(); } }catch(e){}
    });

    function mmss(t){ if(!isFinite(t)||t<0) t=0; var m=Math.floor(t/60), s=Math.floor(t%60); return m+':'+String(s).padStart(2,'0'); }

    function draw(){
      var glow1=(CFG.colors&&CFG.colors.wave1)||'#13d77a';
      var glow2=(CFG.colors&&CFG.colors.wave2)||'#ffd54a';
      ctx.clearRect(0,0,Cw,Ch);

      // Título
      var tx=Math.round(titleSlot.x*Cw/PW), ty=Math.round(titleSlot.y*Ch/PH),
          tw=Math.round(titleSlot.w*Cw/PW), th=Math.round(titleSlot.h*Ch/PH);
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font='800 '+titlePx+'px system-ui,Segoe UI,Roboto';
      ctx.fillStyle='rgba(0,0,0,.28)'; ctx.fillText(CFG.title||'', tx+tw/2+2, ty+th/2+2);
      ctx.fillStyle=(CFG.colors&&CFG.colors.title)||'#000'; ctx.fillText(CFG.title||'', tx+tw/2, ty+th/2);

      // Artista
      var ax=Math.round(artistSlot.x*Cw/PW), ay=Math.round(artistSlot.y*Ch/PH),
          aw=Math.round(artistSlot.w*Cw/PW), ah=Math.round(artistSlot.h*Ch/PH);
      ctx.font='600 '+artistPx+'px system-ui,Segoe UI,Roboto';
      ctx.fillStyle='rgba(0,0,0,.18)'; ctx.fillText(CFG.artist||'', ax+aw/2+1.8, ay+ah/2+1.8);
      ctx.fillStyle=(CFG.colors&&CFG.colors.artist)||'#000'; ctx.fillText(CFG.artist||'', ax+aw/2, ay+ah/2);

      // Barra simple
      var pbx=Math.round(barSlot.x*Cw/PW), pby=Math.round(barSlot.y*Ch/PH),
          pbw=Math.round(barSlot.w*Cw/PW), pbh=Math.max(8,Math.round(barSlot.h*Ch/PH));
      ctx.fillStyle='#000'; ctx.fillRect(pbx, pby, pbw, pbh);
      var p=0, cur='0:00', dur='0:00';
      if(audio && audio.duration>0){ p=audio.currentTime/audio.duration; cur=mmss(audio.currentTime); dur=mmss(audio.duration); }
      var fw=Math.max(2, Math.floor(pbw*p));
      var grad=ctx.createLinearGradient(pbx,0,pbx+fw,0); grad.addColorStop(0, glow1); grad.addColorStop(1, glow2);
      ctx.fillStyle=grad; ctx.fillRect(pbx, pby, fw, pbh);
      ctx.fillStyle='#000';
      ctx.font='700 '+Math.round(32*Cw/2048)+'px system-ui,Segoe UI,Roboto';
      ctx.textAlign='left';  ctx.fillText(cur, pbx, pby - 12);
      ctx.textAlign='right'; ctx.fillText(dur, pbx+pbw, pby - 12);

      if(overlay.__tex) overlay.__tex.needsUpdate = true;
      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    /* ---------- botón cámara ---------- */
    var btnStart=document.getElementById('btnStart');

    // Detecta si ya estaba listo (algunos móviles inicializan rápido)
    var readyScene = scene.hasLoaded;
    var readyMindAR = !!(scene.components && scene.components['mindar-image']);

    scene.addEventListener('loaded', function(){ readyScene=true; armButton(); });
    scene.addEventListener('componentinitialized', function(e){
      if(e.detail && e.detail.name==='mindar-image'){ readyMindAR=true; armButton(); }
    });

    function armButton(){
      if(readyScene && readyMindAR){
        btnStart.disabled=false;
        btnStart.textContent='📷 Abrir cámara';
      }
    }
    armButton(); // intenta habilitarlo ya si procede

    btnStart.addEventListener('click', function(){
      btnStart.disabled=true;
      log('Arrancando MindAR…');
      var comp=scene.components['mindar-image'];
      var sys =scene.systems['mindar-image-system'];
      var p = comp && comp.start ? comp.start() : (sys && sys.start ? sys.start() : Promise.reject(new Error('No MindAR start')));
      Promise.resolve(p).then(function(){
        btnStart.textContent='Cámara lista';
        var mv=mindarVideoEl();
        if(mv){
          mv.setAttribute('playsinline','true');
          mv.setAttribute('webkit-playsinline','true');
          mv.muted=true;
          if(mv.paused){ mv.play().catch(function(){}); }
          log('Cámara OK. paused='+mv.paused+', size='+mv.videoWidth+'x'+mv.videoHeight);
        }else{
          log('MindAR activo pero no veo el video aún…');
        }
      }).catch(function(e){
        btnStart.disabled=false;
        btnStart.textContent='📷 Abrir cámara';
        log('Fallo al iniciar MindAR:', e && e.name, e && e.message || e);
      });
    });

    /* Eventos del target */
    var audioEnabled=false;
    anchor.addEventListener('targetFound', function(){
      v1.play().catch(function(){});
      if(!audioEnabled){ setupAudio(); audioEnabled=true; }
      var mv=mindarVideoEl(); if(mv && mv.paused){ mv.play().catch(function(){}); }
      btnAudio.disabled=false;
      log('Target FOUND');
    });
    anchor.addEventListener('targetLost', function(){
      v1.pause(); if(audio) audio.pause(); btnAudio.textContent='▶️ Audio'; log('Target LOST…');
    });

    /* gesto de seguridad (si algo queda pausado) */
    window.addEventListener('pointerdown', function(){
      var mv=mindarVideoEl(); if(mv && mv.paused) mv.play().catch(function(){});
    }, {passive:true});
  }
})();
</script>
</body>
</html>
